<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluxi - Sistema de Domicilios</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background: #2c3e50;
            color: white;
            padding: 20px 0;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid #34495e;
            margin-bottom: 20px;
        }

        .sidebar-header h2 {
            font-size: 1.2em;
            color: #ecf0f1;
        }

        .menu-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .menu-item:hover {
            background: #34495e;
            border-left-color: #3498db;
        }

        .menu-item.active {
            background: #34495e;
            border-left-color: #3498db;
        }

        .main-content {
            margin-left: 250px;
            padding: 20px;
            min-height: 100vh;
        }

        .module-container {
            display: none;
        }

        .module-container.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .card-header h3 {
            color: #2c3e50;
            font-size: 1.5em;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-whatsapp {
            background: #25D366;
            color: white;
        }

        .btn-whatsapp:hover {
            background: #128C7E;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            margin: 0 2px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th {
            background: #ecf0f1;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
        }

        table td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        .actions-cell {
            white-space: nowrap;
        }

        .actions-cell button {
            margin: 2px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .modal-header h3 {
            color: #2c3e50;
        }

        .modal-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ecf0f1;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-pendiente {
            background: #fff3cd;
            color: #856404;
        }

        .status-asignado {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-en_camino {
            background: #cce5ff;
            color: #004085;
        }

        .status-entregado {
            background: #d4edda;
            color: #155724;
        }

        .status-cancelado {
            background: #f8d7da;
            color: #721c24;
        }

        .order-detail {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .order-detail-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .order-detail-item strong {
            display: block;
            color: #7f8c8d;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .order-detail-item span {
            color: #2c3e50;
            font-size: 16px;
            font-weight: 600;
        }

        #map, #tracking-map {
            background: #e0e0e0;
        }

        .delivery-marker-popup strong {
            color: #2c3e50;
            display: block;
            margin-bottom: 5px;
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-dot.disponible {
            background: #27ae60;
        }

        .status-dot.ocupado {
            background: #f39c12;
        }

        .status-dot.inactivo {
            background: #e74c3c;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .main-content {
                margin-left: 0;
            }

            #map, #tracking-map {
                height: 300px !important;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>üöÄ Fluxi</h2>
        </div>
        <div class="menu-item active" data-module="usuarios">üë• Gesti√≥n de Usuarios</div>
        <div class="menu-item" data-module="domiciliarios">üèçÔ∏è Domiciliarios</div>
        <div class="menu-item" data-module="pedidos">üì¶ Pedidos</div>
        <div class="menu-item" data-module="dashboard">üìä Dashboard</div>
        <div class="menu-item" data-module="configuracion">‚öôÔ∏è Configuraci√≥n</div>
    </div>

    <div class="main-content">
        <div id="module-usuarios" class="module-container active">
            <div class="card">
                <div class="card-header">
                    <h3>üë• Gesti√≥n de Usuarios</h3>
                    <button class="btn btn-primary" id="btn-new-user">+ Nuevo Usuario</button>
                </div>
                <div id="users-alert"></div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 30px;">
                                    Ingrese un nuevo usuario
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="module-domiciliarios" class="module-container">
            <div class="card">
                <div class="card-header">
                    <h3>üèçÔ∏è Gesti√≥n de Domiciliarios</h3>
                    <button class="btn btn-primary" id="btn-new-delivery">+ Nuevo Domiciliario</button>
                </div>
                <div id="delivery-alert"></div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Tel√©fono</th>
                                <th>Estado</th>
                                <th>√öltima Ubicaci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="delivery-table-body">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 30px;">Cargando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>üìç Ubicaci√≥n en Tiempo Real</h3>
                    <button class="btn btn-secondary btn-small" id="btn-refresh-map">üîÑ Actualizar Mapa</button>
                </div>
                <div id="map" style="height: 500px; border-radius: 8px;"></div>
                <div style="margin-top: 10px; font-size: 12px; color: #7f8c8d;">
                    üí° Los domiciliarios deben compartir su ubicaci√≥n para aparecer en el mapa
                </div>
            </div>
        </div>

        <div id="module-pedidos" class="module-container">
            <div class="card">
                <div class="card-header">
                    <h3>üì¶ Gesti√≥n de Pedidos</h3>
                    <button class="btn btn-primary" id="btn-new-order">+ Nuevo Pedido</button>
                </div>
                <div id="orders-alert"></div>
                <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <select id="filter-status" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">Todos los estados</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="asignado">Asignado</option>
                        <option value="en_camino">En camino</option>
                        <option value="entregado">Entregado</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                    <button class="btn btn-secondary btn-small" id="btn-refresh-orders">üîÑ Actualizar</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Direcci√≥n</th>
                                <th>Total</th>
                                <th>Domiciliario</th>
                                <th>Estado</th>
                                <th>Tiempo</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 30px;">Cargando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="module-dashboard" class="module-container">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Pedidos Hoy</div>
                            <div style="font-size: 32px; font-weight: bold;" id="stat-today">0</div>
                        </div>
                        <div style="font-size: 48px; opacity: 0.3;">üì¶</div>
                    </div>
                </div>
                <div class="card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Pedidos Semana</div>
                            <div style="font-size: 32px; font-weight: bold;" id="stat-week">0</div>
                        </div>
                        <div style="font-size: 48px; opacity: 0.3;">üìÖ</div>
                    </div>
                </div>
                <div class="card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Pedidos Mes</div>
                            <div style="font-size: 32px; font-weight: bold;" id="stat-month">0</div>
                        </div>
                        <div style="font-size: 48px; opacity: 0.3;">üìä</div>
                    </div>
                </div>
                <div class="card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Ingresos Mes</div>
                            <div style="font-size: 28px; font-weight: bold;" id="stat-income">$0</div>
                        </div>
                        <div style="font-size: 48px; opacity: 0.3;">üí∞</div>
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div class="card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Domiciliarios Activos</div>
                            <div style="font-size: 32px; font-weight: bold;" id="stat-active-delivery">0</div>
                        </div>
                        <div style="font-size: 48px; opacity: 0.3;">üèçÔ∏è</div>
                    </div>
                </div>
                <div class="card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Tiempo Promedio</div>
                            <div style="font-size: 32px; font-weight: bold;" id="stat-avg-time">--</div>
                        </div>
                        <div style="font-size: 48px; opacity: 0.3;">‚è±Ô∏è</div>
                    </div>
                </div>
                <div class="card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #2c3e50;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.7; margin-bottom: 5px;">Pedidos en Curso</div>
                            <div style="font-size: 32px; font-weight: bold;" id="stat-active-orders">0</div>
                        </div>
                        <div style="font-size: 48px; opacity: 0.3;">üöö</div>
                    </div>
                </div>
                <div class="card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #2c3e50;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.7; margin-bottom: 5px;">Tasa de √âxito</div>
                            <div style="font-size: 32px; font-weight: bold;" id="stat-success-rate">0%</div>
                        </div>
                        <div style="font-size: 48px; opacity: 0.3;">‚úÖ</div>
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                <div class="card">
                    <div class="card-header">
                        <h3>üî• Domiciliarios M√°s Eficientes</h3>
                    </div>
                    <div id="top-deliveries-container">
                        <div style="text-align: center; padding: 30px; color: #7f8c8d;">Cargando datos...</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>üìä Estado de Pedidos</h3>
                    </div>
                    <canvas id="status-chart" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h3>üì¶ Pedidos Recientes</h3>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Total</th>
                                <th>Domiciliario</th>
                                <th>Estado</th>
                                <th>Tiempo</th>
                            </tr>
                        </thead>
                        <tbody id="recent-orders-table">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 30px;">Cargando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h3>üí∞ Ingresos de los √öltimos 7 D√≠as</h3>
                </div>
                <canvas id="income-chart" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <div id="module-configuracion" class="module-container">
            <div class="card">
                <div class="card-header">
                    <h3>‚öôÔ∏è Configuraci√≥n de Fluxi</h3>
                </div>
                <div class="alert alert-success">
                    <strong>‚úÖ Fluxi est√° correctamente configurado con Supabase</strong><br>
                    Tu aplicaci√≥n est√° lista para usar. Las credenciales ya est√°n configuradas.
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h4 style="margin-bottom: 15px;">üìä Estructura de Roles</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Rol</th>
                                <th>Descripci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="badge badge-danger">Administrador</span></td>
                                <td>Acceso completo a todas las funciones del sistema</td>
                            </tr>
                            <tr>
                                <td><span class="badge badge-info">Visualizador</span></td>
                                <td>Solo puede ver informaci√≥n, sin permisos de edici√≥n</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h4 style="margin-bottom: 15px;">üìã Estado de la Base de Datos</h4>
                    <p style="margin-bottom: 10px;">Si las tablas no est√°n creadas, ejecuta este SQL en Supabase:</p>
                    <pre style="background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px;">
CREATE TABLE usuarios (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  nombre TEXT NOT NULL,
  email TEXT NOT NULL,
  telefono TEXT,
  rol TEXT NOT NULL CHECK (rol IN ('administrador', 'visualizador')),
  estado TEXT NOT NULL CHECK (estado IN ('activo', 'inactivo')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE domiciliarios (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  nombre TEXT NOT NULL,
  telefono TEXT NOT NULL,
  estado TEXT NOT NULL CHECK (estado IN ('disponible', 'ocupado', 'inactivo')),
  pedidos_completados INTEGER DEFAULT 0,
  ubicacion JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE pedidos (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  cliente TEXT NOT NULL,
  telefono_cliente TEXT NOT NULL,
  direccion TEXT NOT NULL,
  valor_pedido NUMERIC NOT NULL,
  valor_domicilio NUMERIC NOT NULL,
  metodo_pago TEXT NOT NULL CHECK (metodo_pago IN ('efectivo', 'tarjeta')),
  estado TEXT NOT NULL CHECK (estado IN ('pendiente', 'asignado', 'en_camino', 'entregado', 'cancelado')),
  domiciliario_id UUID,
  domiciliario_nombre TEXT,
  domiciliario_telefono TEXT,
  notas TEXT,
  tiempo_aceptacion BIGINT,
  tiempo_entrega BIGINT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

ALTER TABLE usuarios DISABLE ROW LEVEL SECURITY;
ALTER TABLE domiciliarios DISABLE ROW LEVEL SECURITY;
ALTER TABLE pedidos DISABLE ROW LEVEL SECURITY;</pre>
                </div>
            </div>
        </div>
    </div>

    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="user-modal-title">Nuevo Usuario</h3>
            </div>
            <form id="user-form">
                <div class="form-group">
                    <label>Nombre Completo *</label>
                    <input type="text" id="user-name" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="user-email" required>
                </div>
                <div class="form-group">
                    <label>Tel√©fono</label>
                    <input type="tel" id="user-phone">
                </div>
                <div class="form-group">
                    <label>Rol *</label>
                    <select id="user-role" required>
                        <option value="">Seleccionar...</option>
                        <option value="administrador">Administrador</option>
                        <option value="visualizador">Visualizador</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Estado *</label>
                    <select id="user-status" required>
                        <option value="activo">Activo</option>
                        <option value="inactivo">Inactivo</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="btn-cancel-user">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="delivery-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="delivery-modal-title">Nuevo Domiciliario</h3>
            </div>
            <form id="delivery-form">
                <div class="form-group">
                    <label>Nombre Completo *</label>
                    <input type="text" id="delivery-name" required placeholder="Ej: Juan P√©rez">
                </div>
                <div class="form-group">
                    <label>N√∫mero de Tel√©fono * (con c√≥digo de pa√≠s)</label>
                    <input type="tel" id="delivery-phone" required placeholder="Ej: +573001234567">
                    <small style="color: #7f8c8d; font-size: 12px;">Formato: +57 seguido del n√∫mero (sin espacios)</small>
                </div>
                <div class="form-group">
                    <label>Estado *</label>
                    <select id="delivery-status" required>
                        <option value="disponible">Disponible</option>
                        <option value="ocupado">Ocupado</option>
                        <option value="inactivo">Inactivo</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="btn-cancel-delivery">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="order-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="order-modal-title">Nuevo Pedido</h3>
            </div>
            <form id="order-form">
                <div class="form-group">
                    <label>Nombre del Cliente *</label>
                    <input type="text" id="order-customer-name" required placeholder="Ej: Mar√≠a Rodr√≠guez">
                </div>
                <div class="form-group">
                    <label>Tel√©fono del Cliente *</label>
                    <input type="tel" id="order-customer-phone" required placeholder="Ej: 3001234567">
                </div>
                <div class="form-group">
                    <label>Direcci√≥n de Entrega *</label>
                    <textarea id="order-address" required rows="2" placeholder="Ej: Calle 123 #45-67, Apto 501"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Valor del Pedido *</label>
                        <input type="number" id="order-value" required min="0" step="100" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Valor del Domicilio *</label>
                        <input type="number" id="order-delivery-fee" required min="0" step="100" placeholder="0">
                    </div>
                </div>
                <div class="form-group">
                    <label>Total a Cobrar</label>
                    <input type="text" id="order-total" readonly style="background: #ecf0f1; font-weight: bold; font-size: 18px;">
                </div>
                <div class="form-group">
                    <label>M√©todo de Pago *</label>
                    <select id="order-payment-method" required>
                        <option value="">Seleccionar...</option>
                        <option value="efectivo">Efectivo</option>
                        <option value="tarjeta">Tarjeta</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Asignar Domiciliario</label>
                    <select id="order-delivery-person">
                        <option value="">Sin asignar</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notas Adicionales</label>
                    <textarea id="order-notes" rows="2" placeholder="Ej: Tocar el timbre 3 veces"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="btn-cancel-order">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar Pedido</button>
                </div>
            </form>
        </div>
    </div>

    <div id="tracking-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>üìç Seguimiento del Pedido</h3>
            </div>
            <div id="tracking-info" style="margin-bottom: 20px;"></div>
            <div id="tracking-map" style="height: 400px; border-radius: 8px; margin-bottom: 15px;"></div>
            <div style="display: flex; gap: 10px; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                <div><strong>Estado:</strong> <span id="tracking-status"></span></div>
                <div><strong>Tiempo transcurrido:</strong> <span id="tracking-time">--</span></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="btn-close-tracking">Cerrar</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const SUPABASE_URL = 'https://lbifbexhmvbanvrjfglp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxiaWZiZXhobXZiYW52cmpmZ2xwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5Mjg5MDQsImV4cCI6MjA3NjUwNDkwNH0.ZXjCv4DkNobkn3IDK9wYBjjOV55Bf_UwcSxhkt6YqGo';

        let supabase = null;
        try {
            supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log('%c‚úÖ Fluxi conectado a Supabase', 'color: green; font-weight: bold; font-size: 14px;');
        } catch (error) {
            console.error('‚ùå Error conectando Supabase:', error);
        }

        let currentUserId = null;
        let currentDeliveryId = null;
        let currentOrderId = null;
        let allOrders = [];
        let map = null;
        let markers = {};
        let trackingMap = null;
        let trackingMarker = null;
        let trackingInterval = null;
        let statusChart = null;
        let incomeChart = null;

        function showAlert(containerId, type, message) {
            const container = document.getElementById(containerId);
            const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-error' : 'alert-info';
            container.innerHTML = '<div class="alert ' + alertClass + '">' + message + '</div>';
            setTimeout(function() { container.innerHTML = ''; }, 5000);
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(value);
        }

        function calculateElapsedTime(timestamp) {
            if (!timestamp) return '--';
            const now = Date.now();
            const diff = now - timestamp;
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            return hours > 0 ? hours + 'h ' + minutes + 'm' : minutes + 'm';
        }

        document.querySelectorAll('.menu-item').forEach(function(item) {
            item.addEventListener('click', function() {
                document.querySelectorAll('.menu-item').forEach(function(m) { m.classList.remove('active'); });
                document.querySelectorAll('.module-container').forEach(function(m) { m.classList.remove('active'); });
                this.classList.add('active');
                const moduleName = this.dataset.module;
                document.getElementById('module-' + moduleName).classList.add('active');
                
                if (moduleName === 'domiciliarios') {
                    setTimeout(function() { initMap(); loadDeliveries(); }, 100);
                } else if (moduleName === 'pedidos') {
                    setTimeout(function() { loadOrders(); }, 100);
                } else if (moduleName === 'dashboard') {
                    setTimeout(function() { loadDashboard(); }, 100);
                }
            });
        });

        async function loadUsers() {
            if (!supabase) {
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px; color: #e74c3c;"><strong>‚ö†Ô∏è Error de conexi√≥n</strong></td></tr>';
                return;
            }
            
            try {
                const result = await supabase.from('usuarios').select('*').order('created_at', { ascending: false });
                
                if (result.error) {
                    console.error('Error Supabase:', result.error);
                    showAlert('users-alert', 'error', 'Error: ' + result.error.message);
                    return;
                }
                
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = '';
                
                if (!result.data || result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px;">Ingrese un nuevo usuario</td></tr>';
                    return;
                }
                
                result.data.forEach(function(user) {
                    const row = tbody.insertRow();
                    row.innerHTML = '<td><strong>' + user.nombre + '</strong></td><td>' + user.email + '</td><td></td><td></td><td class="actions-cell"></td>';
                    
                    const roleBadge = document.createElement('span');
                    roleBadge.className = 'badge ' + (user.rol === 'administrador' ? 'badge-danger' : 'badge-info');
                    roleBadge.textContent = user.rol === 'administrador' ? 'Administrador' : 'Visualizador';
                    row.cells[2].appendChild(roleBadge);
                    
                    const statusBadge = document.createElement('span');
                    statusBadge.className = 'badge ' + (user.estado === 'activo' ? 'badge-success' : 'badge-danger');
                    statusBadge.textContent = user.estado === 'activo' ? 'Activo' : 'Inactivo';
                    row.cells[3].appendChild(statusBadge);
                    
                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-primary btn-small';
                    editBtn.textContent = 'Editar';
                    editBtn.onclick = function() { openUserModal(user); };
                    row.cells[4].appendChild(editBtn);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-danger btn-small';
                    deleteBtn.textContent = 'Eliminar';
                    deleteBtn.onclick = function() { deleteUser(user.id); };
                    row.cells[4].appendChild(deleteBtn);
                });
            } catch (error) {
                console.error('Error:', error);
                showAlert('users-alert', 'error', 'Error al cargar: ' + error.message);
            }
        }

        function openUserModal(user) {
            currentUserId = user ? user.id : null;
            document.getElementById('user-modal-title').textContent = user ? 'Editar Usuario' : 'Nuevo Usuario';
            document.getElementById('user-name').value = user ? user.nombre : '';
            document.getElementById('user-email').value = user ? user.email : '';
            document.getElementById('user-phone').value = user ? user.telefono || '' : '';
            document.getElementById('user-role').value = user ? user.rol : '';
            document.getElementById('user-status').value = user ? user.estado : 'activo';
            document.getElementById('user-modal').classList.add('active');
        }

        function closeUserModal() {
            document.getElementById('user-modal').classList.remove('active');
            document.getElementById('user-form').reset();
            currentUserId = null;
        }

        async function deleteUser(id) {
            if (!confirm('¬øEliminar este usuario?')) return;
            try {
                const result = await supabase.from('usuarios').delete().eq('id', id);
                if (result.error) throw result.error;
                showAlert('users-alert', 'success', 'Usuario eliminado correctamente');
                loadUsers();
            } catch (error) {
                showAlert('users-alert', 'error', 'Error: ' + error.message);
            }
        }

        document.getElementById('btn-new-user').addEventListener('click', function() { openUserModal(null); });
        document.getElementById('btn-cancel-user').addEventListener('click', closeUserModal);
        document.getElementById('user-modal').addEventListener('click', function(e) {
            if (e.target === this) closeUserModal();
        });

        document.getElementById('user-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!supabase) {
                showAlert('users-alert', 'error', 'Error de conexi√≥n con Supabase');
                return;
            }
            
            const nombre = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const telefono = document.getElementById('user-phone').value.trim();
            const rol = document.getElementById('user-role').value;
            const estado = document.getElementById('user-status').value;
            
            if (!nombre || !email || !rol) {
                showAlert('users-alert', 'error', 'Por favor completa todos los campos obligatorios');
                return;
            }
            
            const userData = {
                nombre: nombre,
                email: email,
                telefono: telefono,
                rol: rol,
                estado: estado,
                updated_at: new Date().toISOString()
            };
            
            try {
                if (currentUserId) {
                    const result = await supabase.from('usuarios').update(userData).eq('id', currentUserId);
                    if (result.error) throw result.error;
                    showAlert('users-alert', 'success', 'Usuario actualizado correctamente');
                } else {
                    userData.created_at = new Date().toISOString();
                    const result = await supabase.from('usuarios').insert([userData]);
                    if (result.error) throw result.error;
                    showAlert('users-alert', 'success', 'Usuario creado correctamente');
                }
                closeUserModal();
                loadUsers();
            } catch (error) {
                console.error('Error:', error);
                showAlert('users-alert', 'error', 'Error al guardar: ' + error.message);
            }
        });

        function initMap() {
            if (map) return;
            map = L.map('map').setView([4.7110, -74.0721], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
        }

        async function loadDeliveries() {
            if (!supabase) return;
            try {
                const result = await supabase.from('domiciliarios').select('*').order('created_at', { ascending: false });
                const tbody = document.getElementById('delivery-table-body');
                tbody.innerHTML = '';
                
                if (!result.data || result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px;">No hay domiciliarios</td></tr>';
                    return;
                }
                
                result.data.forEach(function(delivery) {
                    const row = tbody.insertRow();
                    row.innerHTML = '<td><strong>' + delivery.nombre + '</strong></td><td>' + delivery.telefono + '</td><td></td><td></td><td class="actions-cell"></td>';
                    
                    const statusBadge = document.createElement('span');
                    statusBadge.className = 'badge ' + (delivery.estado === 'disponible' ? 'badge-success' : delivery.estado === 'ocupado' ? 'badge-warning' : 'badge-danger');
                    statusBadge.textContent = delivery.estado.charAt(0).toUpperCase() + delivery.estado.slice(1);
                    row.cells[2].appendChild(statusBadge);
                    
                    const location = delivery.ubicacion ? new Date(delivery.ubicacion.timestamp).toLocaleString('es-CO') : 'Sin ubicaci√≥n';
                    row.cells[3].textContent = location;
                    row.cells[3].style.fontSize = '12px';
                    
                    const whatsappBtn = document.createElement('button');
                    whatsappBtn.className = 'btn btn-whatsapp btn-small';
                    whatsappBtn.textContent = 'WhatsApp';
                    whatsappBtn.onclick = function() { sendWhatsApp(delivery.telefono.replace(/\D/g, ''), delivery.nombre); };
                    row.cells[4].appendChild(whatsappBtn);
                    
                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-primary btn-small';
                    editBtn.textContent = 'Editar';
                    editBtn.onclick = function() { openDeliveryModal(delivery); };
                    row.cells[4].appendChild(editBtn);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-danger btn-small';
                    deleteBtn.textContent = 'Eliminar';
                    deleteBtn.onclick = function() { deleteDelivery(delivery.id); };
                    row.cells[4].appendChild(deleteBtn);
                    
                    if (delivery.ubicacion && delivery.ubicacion.lat && delivery.ubicacion.lng) {
                        updateMarker(delivery.id, delivery);
                    }
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function updateMarker(id, delivery) {
            if (!map) initMap();
            const lat = delivery.ubicacion.lat;
            const lng = delivery.ubicacion.lng;
            
            if (markers[id]) {
                markers[id].setLatLng([lat, lng]);
            } else {
                const color = delivery.estado === 'disponible' ? '#27ae60' : delivery.estado === 'ocupado' ? '#f39c12' : '#e74c3c';
                const iconDiv = document.createElement('div');
                iconDiv.style.cssText = 'background:' + color + ';width:30px;height:30px;border-radius:50%;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;font-size:16px';
                iconDiv.textContent = 'üèçÔ∏è';
                
                const icon = L.divIcon({ className: 'custom-marker', html: iconDiv.outerHTML, iconSize: [30, 30] });
                const marker = L.marker([lat, lng], { icon }).addTo(map);
                marker.bindPopup('<strong>' + delivery.nombre + '</strong><br>' + delivery.telefono);
                markers[id] = marker;
            }
        }

        function sendWhatsApp(phone, name) {
            const msg = 'Hola ' + name + '! Has recibido un nuevo pedido. Por favor comparte tu ubicaci√≥n en tiempo real.';
            window.open('https://wa.me/' + phone + '?text=' + encodeURIComponent(msg), '_blank');
        }

        function openDeliveryModal(delivery) {
            currentDeliveryId = delivery ? delivery.id : null;
            document.getElementById('delivery-modal-title').textContent = delivery ? 'Editar Domiciliario' : 'Nuevo Domiciliario';
            document.getElementById('delivery-name').value = delivery ? delivery.nombre : '';
            document.getElementById('delivery-phone').value = delivery ? delivery.telefono : '';
            document.getElementById('delivery-status').value = delivery ? delivery.estado : 'disponible';
            document.getElementById('delivery-modal').classList.add('active');
        }

        function closeDeliveryModal() {
            document.getElementById('delivery-modal').classList.remove('active');
            document.getElementById('delivery-form').reset();
            currentDeliveryId = null;
        }

        async function deleteDelivery(id) {
            if (!confirm('¬øEliminar este domiciliario?')) return;
            try {
                await supabase.from('domiciliarios').delete().eq('id', id);
                if (markers[id]) {
                    map.removeLayer(markers[id]);
                    delete markers[id];
                }
                showAlert('delivery-alert', 'success', 'Domiciliario eliminado');
                loadDeliveries();
            } catch (error) {
                showAlert('delivery-alert', 'error', 'Error al eliminar');
            }
        }

        document.getElementById('btn-new-delivery').addEventListener('click', function() { openDeliveryModal(null); });
        document.getElementById('btn-cancel-delivery').addEventListener('click', closeDeliveryModal);
        document.getElementById('btn-refresh-map').addEventListener('click', loadDeliveries);
        document.getElementById('delivery-modal').addEventListener('click', function(e) {
            if (e.target === this) closeDeliveryModal();
        });

        document.getElementById('delivery-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const deliveryData = {
                nombre: document.getElementById('delivery-name').value,
                telefono: document.getElementById('delivery-phone').value,
                estado: document.getElementById('delivery-status').value,
                updated_at: new Date().toISOString()
            };
            
            try {
                if (currentDeliveryId) {
                    await supabase.from('domiciliarios').update(deliveryData).eq('id', currentDeliveryId);
                    showAlert('delivery-alert', 'success', 'Domiciliario actualizado');
                } else {
                    deliveryData.created_at = new Date().toISOString();
                    deliveryData.pedidos_completados = 0;
                    await supabase.from('domiciliarios').insert([deliveryData]);
                    showAlert('delivery-alert', 'success', 'Domiciliario creado');
                }
                closeDeliveryModal();
                loadDeliveries();
            } catch (error) {
                showAlert('delivery-alert', 'error', 'Error al guardar');
            }
        });

        async function loadOrders() {
            if (!supabase) return;
            try {
                const result = await supabase.from('pedidos').select('*').order('created_at', { ascending: false });
                allOrders = result.data || [];
                renderOrders(allOrders);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderOrders(orders) {
            const tbody = document.getElementById('orders-table-body');
            tbody.innerHTML = '';
            
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px;">No hay pedidos</td></tr>';
                return;
            }
            
            orders.forEach(function(order) {
                const row = tbody.insertRow();
                row.innerHTML = '<td><strong>#' + order.id.substring(0, 8) + '</strong></td><td><strong>' + order.cliente + '</strong><br><small>' + order.telefono_cliente + '</small></td><td>' + order.direccion + '</td><td><strong>' + formatCurrency(order.valor_pedido + order.valor_domicilio) + '</strong></td><td>' + (order.domiciliario_nombre || 'Sin asignar') + '</td><td></td><td>' + (order.tiempo_aceptacion ? calculateElapsedTime(order.tiempo_aceptacion) : '--') + '</td><td class="actions-cell"></td>';
                
                const statusBadge = document.createElement('span');
                statusBadge.className = 'status-badge status-' + order.estado;
                statusBadge.textContent = order.estado.charAt(0).toUpperCase() + order.estado.slice(1);
                row.cells[5].appendChild(statusBadge);
                
                if (order.estado !== 'entregado' && order.estado !== 'cancelado') {
                    const changeBtn = document.createElement('button');
                    changeBtn.className = 'btn btn-primary btn-small';
                    changeBtn.textContent = 'Cambiar Estado';
                    changeBtn.onclick = function() { changeOrderStatus(order.id); };
                    row.cells[7].appendChild(changeBtn);
                }
                
                if (order.estado === 'en_camino' && order.domiciliario_id) {
                    const trackBtn = document.createElement('button');
                    trackBtn.className = 'btn btn-success btn-small';
                    trackBtn.textContent = 'Rastrear';
                    trackBtn.onclick = function() { openTracking(order); };
                    row.cells[7].appendChild(trackBtn);
                }
                
                const viewBtn = document.createElement('button');
                viewBtn.className = 'btn btn-secondary btn-small';
                viewBtn.textContent = 'Ver';
                viewBtn.onclick = function() { viewOrderDetails(order); };
                row.cells[7].appendChild(viewBtn);
                
                if (order.estado === 'pendiente') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-danger btn-small';
                    deleteBtn.textContent = 'Eliminar';
                    deleteBtn.onclick = function() { deleteOrder(order.id); };
                    row.cells[7].appendChild(deleteBtn);
                }
            });
        }

        function filterOrders() {
            const status = document.getElementById('filter-status').value;
            const filtered = status ? allOrders.filter(function(o) { return o.estado === status; }) : allOrders;
            renderOrders(filtered);
        }

        async function changeOrderStatus(orderId) {
            const order = allOrders.find(function(o) { return o.id === orderId; });
            if (!order) return;
            
            const nextStatus = { 'pendiente': 'asignado', 'asignado': 'en_camino', 'en_camino': 'entregado' }[order.estado];
            if (!nextStatus) return;
            if (!confirm('¬øCambiar estado?')) return;
            
            try {
                const updateData = { estado: nextStatus, updated_at: new Date().toISOString() };
                if (nextStatus === 'asignado' && !order.tiempo_aceptacion) updateData.tiempo_aceptacion = Date.now();
                if (nextStatus === 'entregado') updateData.tiempo_entrega = Date.now();
                
                await supabase.from('pedidos').update(updateData).eq('id', orderId);
                showAlert('orders-alert', 'success', 'Estado actualizado');
                loadOrders();
            } catch (error) {
                showAlert('orders-alert', 'error', 'Error');
            }
        }

        async function deleteOrder(orderId) {
            if (!confirm('¬øEliminar pedido?')) return;
            try {
                await supabase.from('pedidos').delete().eq('id', orderId);
                showAlert('orders-alert', 'success', 'Pedido eliminado');
                loadOrders();
            } catch (error) {
                showAlert('orders-alert', 'error', 'Error');
            }
        }

        function viewOrderDetails(order) {
            alert('PEDIDO #' + order.id.substring(0, 8) + '\n\nCliente: ' + order.cliente + '\nDirecci√≥n: ' + order.direccion + '\nTotal: ' + formatCurrency(order.valor_pedido + order.valor_domicilio));
        }

        function openTracking(order) {
            document.getElementById('tracking-modal').classList.add('active');
            document.getElementById('tracking-info').innerHTML = '<div><strong>Cliente:</strong> ' + order.cliente + '</div><div><strong>Direcci√≥n:</strong> ' + order.direccion + '</div>';
            
            if (!trackingMap) {
                trackingMap = L.map('tracking-map').setView([4.7110, -74.0721], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(trackingMap);
            }
        }

        function closeTrackingModal() {
            document.getElementById('tracking-modal').classList.remove('active');
            if (trackingInterval) clearInterval(trackingInterval);
            if (trackingMarker && trackingMap) trackingMap.removeLayer(trackingMarker);
            trackingMarker = null;
        }

        async function loadAvailableDeliveries() {
            if (!supabase) return;
            try {
                const result = await supabase.from('domiciliarios').select('*').in('estado', ['disponible', 'ocupado']);
                const select = document.getElementById('order-delivery-person');
                select.innerHTML = '<option value="">Sin asignar</option>';
                
                if (result.data) {
                    result.data.forEach(function(d) {
                        const option = document.createElement('option');
                        option.value = d.id;
                        option.dataset.name = d.nombre;
                        option.dataset.phone = d.telefono;
                        option.textContent = d.nombre + ' - ' + (d.estado === 'disponible' ? 'Disponible' : 'Ocupado');
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function openOrderModal(order) {
            currentOrderId = order ? order.id : null;
            document.getElementById('order-modal-title').textContent = order ? 'Editar Pedido' : 'Nuevo Pedido';
            if (order) {
                document.getElementById('order-customer-name').value = order.cliente;
                document.getElementById('order-customer-phone').value = order.telefono_cliente;
                document.getElementById('order-address').value = order.direccion;
                document.getElementById('order-value').value = order.valor_pedido;
                document.getElementById('order-delivery-fee').value = order.valor_domicilio;
                document.getElementById('order-payment-method').value = order.metodo_pago;
                document.getElementById('order-delivery-person').value = order.domiciliario_id || '';
                document.getElementById('order-notes').value = order.notas || '';
                calculateTotal();
            } else {
                document.getElementById('order-form').reset();
            }
            loadAvailableDeliveries();
            document.getElementById('order-modal').classList.add('active');
        }

        function closeOrderModal() {
            document.getElementById('order-modal').classList.remove('active');
            document.getElementById('order-form').reset();
            currentOrderId = null;
        }

        function calculateTotal() {
            const orderValue = parseFloat(document.getElementById('order-value').value) || 0;
            const deliveryFee = parseFloat(document.getElementById('order-delivery-fee').value) || 0;
            document.getElementById('order-total').value = formatCurrency(orderValue + deliveryFee);
        }

        document.getElementById('btn-new-order').addEventListener('click', function() { openOrderModal(null); });
        document.getElementById('btn-cancel-order').addEventListener('click', closeOrderModal);
        document.getElementById('btn-refresh-orders').addEventListener('click', loadOrders);
        document.getElementById('btn-close-tracking').addEventListener('click', closeTrackingModal);
        document.getElementById('filter-status').addEventListener('change', filterOrders);
        document.getElementById('order-value').addEventListener('input', calculateTotal);
        document.getElementById('order-delivery-fee').addEventListener('input', calculateTotal);
        document.getElementById('order-modal').addEventListener('click', function(e) {
            if (e.target === this) closeOrderModal();
        });
        document.getElementById('tracking-modal').addEventListener('click', function(e) {
            if (e.target === this) closeTrackingModal();
        });

        document.getElementById('order-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const select = document.getElementById('order-delivery-person');
            const option = select.options[select.selectedIndex];
            
            const orderData = {
                cliente: document.getElementById('order-customer-name').value,
                telefono_cliente: document.getElementById('order-customer-phone').value,
                direccion: document.getElementById('order-address').value,
                valor_pedido: parseFloat(document.getElementById('order-value').value),
                valor_domicilio: parseFloat(document.getElementById('order-delivery-fee').value),
                metodo_pago: document.getElementById('order-payment-method').value,
                domiciliario_id: select.value || null,
                domiciliario_nombre: option.dataset.name || null,
                domiciliario_telefono: option.dataset.phone || null,
                notas: document.getElementById('order-notes').value,
                updated_at: new Date().toISOString()
            };
            
            if (!orderData.domiciliario_id) {
                orderData.estado = 'pendiente';
            } else {
                orderData.estado = 'asignado';
                orderData.tiempo_aceptacion = Date.now();
            }
            
            try {
                if (currentOrderId) {
                    await supabase.from('pedidos').update(orderData).eq('id', currentOrderId);
                    showAlert('orders-alert', 'success', 'Pedido actualizado');
                } else {
                    orderData.created_at = new Date().toISOString();
                    await supabase.from('pedidos').insert([orderData]);
                    showAlert('orders-alert', 'success', 'Pedido creado');
                }
                closeOrderModal();
                loadOrders();
            } catch (error) {
                showAlert('orders-alert', 'error', 'Error al guardar');
            }
        });

        async function loadDashboard() {
            if (!supabase) return;
            try {
                const ordersResult = await supabase.from('pedidos').select('*');
                const deliveriesResult = await supabase.from('domiciliarios').select('*');
                
                const orders = ordersResult.data || [];
                const deliveries = deliveriesResult.data || [];
                
                const now = new Date();
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                const weekStart = todayStart - 518400000;
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
                
                const todayOrders = orders.filter(function(o) { return new Date(o.created_at).getTime() >= todayStart; });
                const weekOrders = orders.filter(function(o) { return new Date(o.created_at).getTime() >= weekStart; });
                const monthOrders = orders.filter(function(o) { return new Date(o.created_at).getTime() >= monthStart; });
                const monthIncome = monthOrders.reduce(function(sum, o) { return sum + (o.valor_pedido || 0) + (o.valor_domicilio || 0); }, 0);
                const activeDeliveries = deliveries.filter(function(d) { return d.estado === 'disponible' || d.estado === 'ocupado'; }).length;
                const activeOrders = orders.filter(function(o) { return o.estado === 'asignado' || o.estado === 'en_camino'; }).length;
                const completedOrders = orders.filter(function(o) { return o.estado === 'entregado'; }).length;
                const successRate = orders.length > 0 ? Math.round((completedOrders / orders.length) * 100) : 0;
                
                document.getElementById('stat-today').textContent = todayOrders.length;
                document.getElementById('stat-week').textContent = weekOrders.length;
                document.getElementById('stat-month').textContent = monthOrders.length;
                document.getElementById('stat-income').textContent = formatCurrency(monthIncome);
                document.getElementById('stat-active-delivery').textContent = activeDeliveries;
                document.getElementById('stat-active-orders').textContent = activeOrders;
                document.getElementById('stat-success-rate').textContent = successRate + '%';
                
                const deliveredOrders = orders.filter(function(o) { return o.estado === 'entregado' && o.tiempo_aceptacion && o.tiempo_entrega; });
                let avgTime = '--';
                if (deliveredOrders.length > 0) {
                    const totalTime = deliveredOrders.reduce(function(sum, o) { return sum + (o.tiempo_entrega - o.tiempo_aceptacion); }, 0);
                    const avgMinutes = Math.round((totalTime / deliveredOrders.length) / 60000);
                    avgTime = Math.floor(avgMinutes / 60) + 'h ' + (avgMinutes % 60) + 'm';
                }
                document.getElementById('stat-avg-time').textContent = avgTime;
                
                renderTopDeliveries(orders);
                renderStatusChart(orders);
                renderIncomeChart(orders);
                renderRecentOrders(orders);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderTopDeliveries(orders) {
            const container = document.getElementById('top-deliveries-container');
            container.innerHTML = '<div style="text-align: center; padding: 30px; color: #7f8c8d;">No hay datos suficientes</div>';
        }

        function renderStatusChart(orders) {
            const statusCount = { pendiente: 0, asignado: 0, en_camino: 0, entregado: 0, cancelado: 0 };
            orders.forEach(function(o) { if (statusCount[o.estado] !== undefined) statusCount[o.estado]++; });
            
            const ctx = document.getElementById('status-chart');
            if (statusChart) statusChart.destroy();
            
            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pendiente', 'Asignado', 'En Camino', 'Entregado', 'Cancelado'],
                    datasets: [{
                        data: [statusCount.pendiente, statusCount.asignado, statusCount.en_camino, statusCount.entregado, statusCount.cancelado],
                        backgroundColor: ['#f39c12', '#3498db', '#2ecc71', '#27ae60', '#e74c3c']
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function renderIncomeChart(orders) {
            const last7Days = [];
            const incomeByDay = {};
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const key = date.toISOString().split('T')[0];
                const label = date.toLocaleDateString('es-CO', { weekday: 'short', day: 'numeric' });
                last7Days.push({ key: key, label: label });
                incomeByDay[key] = 0;
            }
            
            orders.forEach(function(o) {
                if (o.estado === 'entregado' && o.created_at) {
                    const key = new Date(o.created_at).toISOString().split('T')[0];
                    if (incomeByDay[key] !== undefined) {
                        incomeByDay[key] += (o.valor_pedido || 0) + (o.valor_domicilio || 0);
                    }
                }
            });
            
            const ctx = document.getElementById('income-chart');
            if (incomeChart) incomeChart.destroy();
            
            incomeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days.map(function(d) { return d.label; }),
                    datasets: [{
                        label: 'Ingresos',
                        data: last7Days.map(function(d) { return incomeByDay[d.key]; }),
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        function renderRecentOrders(orders) {
            const tbody = document.getElementById('recent-orders-table');
            tbody.innerHTML = '';
            const recent = orders.sort(function(a, b) { return new Date(b.created_at) - new Date(a.created_at); }).slice(0, 10);
            
            if (recent.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px;">No hay pedidos</td></tr>';
                return;
            }
            
            recent.forEach(function(order) {
                const row = tbody.insertRow();
                row.innerHTML = '<td>#' + order.id.substring(0, 8) + '</td><td>' + order.cliente + '</td><td>' + formatCurrency(order.valor_pedido + order.valor_domicilio) + '</td><td>' + (order.domiciliario_nombre || 'Sin asignar') + '</td><td></td><td>' + (order.tiempo_aceptacion ? calculateElapsedTime(order.tiempo_aceptacion) : '--') + '</td>';
                
                const statusBadge = document.createElement('span');
                statusBadge.className = 'status-badge status-' + order.estado;
                statusBadge.textContent = order.estado.charAt(0).toUpperCase() + order.estado.slice(1);
                row.cells[4].appendChild(statusBadge);
            });
        }

        loadUsers();
    </script>
</body>
</html>