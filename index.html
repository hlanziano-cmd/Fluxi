<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Domicilios</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background: #2c3e50;
            color: white;
            padding: 20px 0;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid #34495e;
            margin-bottom: 20px;
        }

        .sidebar-header h2 {
            font-size: 1.2em;
            color: #ecf0f1;
        }

        .menu-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .menu-item:hover {
            background: #34495e;
            border-left-color: #3498db;
        }

        .menu-item.active {
            background: #34495e;
            border-left-color: #3498db;
        }

        .menu-item i {
            margin-right: 10px;
        }

        /* Main Content */
        .main-content {
            margin-left: 250px;
            padding: 20px;
            min-height: 100vh;
        }

        .module-container {
            display: none;
        }

        .module-container.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .card-header h3 {
            color: #2c3e50;
            font-size: 1.5em;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            margin: 0 2px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th {
            background: #ecf0f1;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
        }

        table td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        .actions-cell {
            white-space: nowrap;
        }

        .actions-cell button {
            margin: 2px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .modal-header h3 {
            color: #2c3e50;
        }

        .modal-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ecf0f1;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Alert */
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Map Container */
        #map {
            background: #e0e0e0;
        }

        .leaflet-container {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .delivery-marker-popup {
            font-size: 13px;
        }

        .delivery-marker-popup strong {
            color: #2c3e50;
            display: block;
            margin-bottom: 5px;
        }

        .delivery-marker-popup .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-dot.disponible {
            background: #27ae60;
        }

        .status-dot.ocupado {
            background: #f39c12;
        }

        .status-dot.inactivo {
            background: #e74c3c;
        }

        /* WhatsApp Button */
        .btn-whatsapp {
            background: #25D366;
            color: white;
        }

        .btn-whatsapp:hover {
            background: #128C7E;
        }

        /* Order Status Colors */
        .status-badge {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-pendiente {
            background: #fff3cd;
            color: #856404;
        }

        .status-asignado {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-en_camino {
            background: #cce5ff;
            color: #004085;
        }

        .status-entregado {
            background: #d4edda;
            color: #155724;
        }

        .status-cancelado {
            background: #f8d7da;
            color: #721c24;
        }

        /* Order Details */
        .order-detail {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .order-detail-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .order-detail-item strong {
            display: block;
            color: #7f8c8d;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .order-detail-item span {
            color: #2c3e50;
            font-size: 16px;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .main-content {
                margin-left: 0;
            }

            #map {
                height: 300px !important;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>üöö Domicilios App</h2>
        </div>
        <div class="menu-item active" data-module="usuarios">
            üë• Gesti√≥n de Usuarios
        </div>
        <div class="menu-item" data-module="domiciliarios">
            üèçÔ∏è Domiciliarios
        </div>
        <div class="menu-item" data-module="pedidos">
            üì¶ Pedidos
        </div>
        <div class="menu-item" data-module="dashboard">
            üìä Dashboard
        </div>
        <div class="menu-item" data-module="configuracion">
            ‚öôÔ∏è Configuraci√≥n
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- M√ìDULO: GESTI√ìN DE USUARIOS -->
        <div id="module-usuarios" class="module-container active">
            <div class="card">
                <div class="card-header">
                    <h3>üë• Gesti√≥n de Usuarios</h3>
                    <button class="btn btn-primary" onclick="openUserModal()">+ Nuevo Usuario</button>
                </div>

                <div id="users-alert"></div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 30px;">
                                    Cargando usuarios...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- M√ìDULO: DOMICILIARIOS -->
        <div id="module-domiciliarios" class="module-container">
            <!-- Card de Domiciliarios -->
            <div class="card">
                <div class="card-header">
                    <h3>üèçÔ∏è Gesti√≥n de Domiciliarios</h3>
                    <button class="btn btn-primary" onclick="openDeliveryModal()">+ Nuevo Domiciliario</button>
                </div>

                <div id="delivery-alert"></div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Tel√©fono</th>
                                <th>Estado</th>
                                <th>√öltima Ubicaci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="delivery-table-body">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 30px;">
                                    Cargando domiciliarios...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Card de Mapa en Tiempo Real -->
            <div class="card">
                <div class="card-header">
                    <h3>üìç Ubicaci√≥n en Tiempo Real</h3>
                    <button class="btn btn-secondary btn-small" onclick="refreshMap()">üîÑ Actualizar Mapa</button>
                </div>
                <div id="map" style="height: 500px; border-radius: 8px;"></div>
                <div style="margin-top: 10px; font-size: 12px; color: #7f8c8d;">
                    üí° Los domiciliarios deben compartir su ubicaci√≥n para aparecer en el mapa
                </div>
            </div>
        </div>

        <!-- M√ìDULO: PEDIDOS -->
        <div id="module-pedidos" class="module-container">
            <!-- Card de Pedidos -->
            <div class="card">
                <div class="card-header">
                    <h3>üì¶ Gesti√≥n de Pedidos</h3>
                    <button class="btn btn-primary" onclick="openOrderModal()">+ Nuevo Pedido</button>
                </div>

                <div id="orders-alert"></div>

                <!-- Filtros -->
                <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <select id="filter-status" onchange="filterOrders()" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">Todos los estados</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="asignado">Asignado</option>
                        <option value="en_camino">En camino</option>
                        <option value="entregado">Entregado</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                    <button class="btn btn-secondary btn-small" onclick="loadOrders()">üîÑ Actualizar</button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Direcci√≥n</th>
                                <th>Total</th>
                                <th>Domiciliario</th>
                                <th>Estado</th>
                                <th>Tiempo</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 30px;">
                                    Cargando pedidos...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- M√ìDULO: DASHBOARD -->
        <div id="module-dashboard" class="module-container">
            <!-- Estad√≠sticas Principales -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Card Pedidos Hoy -->
                <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Pedidos Hoy</div>
                            <div style="font-size: 32px; font-weight: bold;" id="stat-today">0</div>
                        </div>
                        <div style="font-size: 48px; opacity: 0.3;">üì¶</div>
                    </div>
                </div>

                <!-- Card Pedidos Semana -->
                <div class="card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Pedidos Semana</div>
                            <div style="font-size: 32px; font-weight: bold;" id="stat-week">0</div>
                        </div>
                        <div style="font-size: 48px; opacity: 0.3;">üìÖ</div>
                    </div>
                </div>

                <!-- Card Pedidos Mes -->
                <div class="card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Pedidos Mes</div>
                            <div style="font-size: 32px; font-weight: bold;" id="stat-month">0</div>
                        </div>
                        <div style="font-size: 48px; opacity: 0.3;">üìä</div>
                    </div>
                </div>

                <!-- Card Ingresos Totales -->
                <div class="card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Ingresos Mes</div>
                            <div style="font-size: 28px; font-weight: bold;" id="stat-income">$0</div>
                        </div>
                        <div style="font-size: 48px; opacity: 0.3;">üí∞</div>
                    </div>
                </div>
            </div>

            <!-- Segunda Fila de Estad√≠sticas -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Card Domiciliarios Activos -->
                <div class="card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Domiciliarios Activos</div>
                            <div style="font-size: 32px; font-weight: bold;" id="stat-active-delivery">0</div>
                        </div>
                        <div style="font-size: 48px; opacity: 0.3;">üèçÔ∏è</div>
                    </div>
                </div>

                <!-- Card Tiempo Promedio -->
                <div class="card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Tiempo Promedio</div>
                            <div style="font-size: 32px; font-weight: bold;" id="stat-avg-time">--</div>
                        </div>
                        <div style="font-size: 48px; opacity: 0.3;">‚è±Ô∏è</div>
                    </div>
                </div>

                <!-- Card Pedidos Activos -->
                <div class="card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #2c3e50;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.7; margin-bottom: 5px;">Pedidos en Curso</div>
                            <div style="font-size: 32px; font-weight: bold;" id="stat-active-orders">0</div>
                        </div>
                        <div style="font-size: 48px; opacity: 0.3;">üöö</div>
                    </div>
                </div>

                <!-- Card Tasa de Completados -->
                <div class="card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #2c3e50;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.7; margin-bottom: 5px;">Tasa de √âxito</div>
                            <div style="font-size: 32px; font-weight: bold;" id="stat-success-rate">0%</div>
                        </div>
                        <div style="font-size: 48px; opacity: 0.3;">‚úÖ</div>
                    </div>
                </div>
            </div>

            <!-- Gr√°ficos y Rankings -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                <!-- Top Domiciliarios -->
                <div class="card">
                    <div class="card-header">
                        <h3>üî• Domiciliarios M√°s Eficientes</h3>
                    </div>
                    <div id="top-deliveries-container">
                        <div style="text-align: center; padding: 30px; color: #7f8c8d;">
                            Cargando datos...
                        </div>
                    </div>
                </div>

                <!-- Distribuci√≥n de Estados -->
                <div class="card">
                    <div class="card-header">
                        <h3>üìä Estado de Pedidos</h3>
                    </div>
                    <canvas id="status-chart" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <!-- Pedidos Recientes -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h3>üì¶ Pedidos Recientes</h3>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Total</th>
                                <th>Domiciliario</th>
                                <th>Estado</th>
                                <th>Tiempo</th>
                            </tr>
                        </thead>
                        <tbody id="recent-orders-table">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 30px;">
                                    Cargando pedidos recientes...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Gr√°fico de Ingresos por D√≠a -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h3>üí∞ Ingresos de los √öltimos 7 D√≠as</h3>
                </div>
                <canvas id="income-chart" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <!-- M√ìDULO: CONFIGURACI√ìN (Placeholder) -->
        <div id="module-configuracion" class="module-container">
            <div class="card">
                <div class="card-header">
                    <h3>‚öôÔ∏è Configuraci√≥n</h3>
                </div>
                <div class="alert alert-info">
                    <strong>Configuraci√≥n de Firebase:</strong><br>
                    Para usar esta aplicaci√≥n, debes agregar tu configuraci√≥n de Firebase en el c√≥digo JavaScript.
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Pedido -->
    <div id="order-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="order-modal-title">Nuevo Pedido</h3>
            </div>
            
            <form id="order-form">
                <div class="form-group">
                    <label>Nombre del Cliente *</label>
                    <input type="text" id="order-customer-name" required placeholder="Ej: Mar√≠a Rodr√≠guez">
                </div>

                <div class="form-group">
                    <label>Tel√©fono del Cliente *</label>
                    <input type="tel" id="order-customer-phone" required placeholder="Ej: 3001234567">
                </div>
                
                <div class="form-group">
                    <label>Direcci√≥n de Entrega *</label>
                    <textarea id="order-address" required rows="2" placeholder="Ej: Calle 123 #45-67, Apto 501, Torre 2"></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Valor del Pedido *</label>
                        <input type="number" id="order-value" required min="0" step="100" placeholder="0" onchange="calculateTotal()">
                    </div>
                    
                    <div class="form-group">
                        <label>Valor del Domicilio *</label>
                        <input type="number" id="order-delivery-fee" required min="0" step="100" placeholder="0" onchange="calculateTotal()">
                    </div>
                </div>

                <div class="form-group">
                    <label>Total a Cobrar</label>
                    <input type="text" id="order-total" readonly style="background: #ecf0f1; font-weight: bold; font-size: 18px;">
                </div>

                <div class="form-group">
                    <label>M√©todo de Pago *</label>
                    <select id="order-payment-method" required>
                        <option value="">Seleccionar...</option>
                        <option value="efectivo">Efectivo</option>
                        <option value="tarjeta">Tarjeta</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Asignar Domiciliario</label>
                    <select id="order-delivery-person">
                        <option value="">Sin asignar</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Notas Adicionales</label>
                    <textarea id="order-notes" rows="2" placeholder="Ej: Tocar el timbre 3 veces"></textarea>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeOrderModal()">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar Pedido</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Seguimiento -->
    <div id="tracking-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>üìç Seguimiento del Pedido</h3>
            </div>
            
            <div id="tracking-info" style="margin-bottom: 20px;">
                <!-- Info del pedido se cargar√° aqu√≠ -->
            </div>

            <div id="tracking-map" style="height: 400px; border-radius: 8px; margin-bottom: 15px;"></div>

            <div style="display: flex; gap: 10px; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                <div>
                    <strong>Estado:</strong> <span id="tracking-status"></span>
                </div>
                <div>
                    <strong>Tiempo transcurrido:</strong> <span id="tracking-time">--</span>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeTrackingModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Domiciliario -->
    <div id="delivery-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="delivery-modal-title">Nuevo Domiciliario</h3>
            </div>
            
            <form id="delivery-form">
                <div class="form-group">
                    <label>Nombre Completo *</label>
                    <input type="text" id="delivery-name" required placeholder="Ej: Juan P√©rez">
                </div>
                
                <div class="form-group">
                    <label>N√∫mero de Tel√©fono * (con c√≥digo de pa√≠s)</label>
                    <input type="tel" id="delivery-phone" required placeholder="Ej: +573001234567">
                    <small style="color: #7f8c8d; font-size: 12px;">Formato: +57 seguido del n√∫mero (sin espacios)</small>
                </div>
                
                <div class="form-group">
                    <label>Estado *</label>
                    <select id="delivery-status" required>
                        <option value="disponible">Disponible</option>
                        <option value="ocupado">Ocupado</option>
                        <option value="inactivo">Inactivo</option>
                    </select>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeDeliveryModal()">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Usuario -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Nuevo Usuario</h3>
            </div>
            
            <form id="user-form">
                <div class="form-group">
                    <label>Nombre Completo *</label>
                    <input type="text" id="user-name" required>
                </div>
                
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="user-email" required>
                </div>
                
                <div class="form-group">
                    <label>Tel√©fono</label>
                    <input type="tel" id="user-phone">
                </div>
                
                <div class="form-group">
                    <label>Rol *</label>
                    <select id="user-role" required>
                        <option value="">Seleccionar...</option>
                        <option value="admin">Administrador</option>
                        <option value="operador">Operador</option>
                        <option value="supervisor">Supervisor</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Estado *</label>
                    <select id="user-status" required>
                        <option value="activo">Activo</option>
                        <option value="inactivo">Inactivo</option>
                    </select>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // ‚ö†Ô∏è CONFIGURA TU SUPABASE AQU√ç
        // 1. Ve a https://supabase.com y crea una cuenta gratis
        // 2. Crea un nuevo proyecto (toma 2 minutos)
        // 3. Ve a Settings > API
        // 4. Copia la URL y la anon/public key
        const SUPABASE_URL = 'https://tu-proyecto.supabase.co';
        const SUPABASE_KEY = 'tu-anon-key-aqui';

        // Inicializar Supabase
        let supabase = null;
        try {
            supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log('‚úÖ Supabase conectado correctamente');
            
            // Verificar conexi√≥n
            testConnection();
        } catch (error) {
            console.error('‚ùå Error al conectar Supabase:', error);
            showAlert('users-alert', 'error', 'Error: Configura Supabase en el c√≥digo. Revisa la consola para m√°s detalles.');
        }

        // Funci√≥n para verificar conexi√≥n
        async function testConnection() {
            if (!supabase) return;
            
            try {
                const { data, error } = await supabase.from('usuarios').select('count', { count: 'exact', head: true });
                if (error && error.message.includes('relation')) {
                    console.warn('‚ö†Ô∏è Tablas no creadas a√∫n. Usa el SQL proporcionado para crearlas.');
                }
            } catch (error) {
                console.error('Error verificando conexi√≥n:', error);
            }
        }

        // Variables globales
        let currentUserId = null;

        // Funci√≥n auxiliar para escapar HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== NAVEGACI√ìN DE M√ìDULOS ====================
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function() {
                // Remover clase active de todos
                document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
                document.querySelectorAll('.module-container').forEach(m => m.classList.remove('active'));
                
                // Activar el seleccionado
                this.classList.add('active');
                const moduleName = this.dataset.module;
                document.getElementById('module-' + moduleName).classList.add('active');
            });
        });

        // ==================== M√ìDULO: USUARIOS ====================
        
        // Cargar usuarios
        async function loadUsers() {
            if (!supabase) {
                document.getElementById('users-table-body').innerHTML = 
                    '<tr><td colspan="5" style="text-align: center; padding: 30px; color: #e74c3c;">' +
                    '<strong>‚ö†Ô∏è Supabase no configurado</strong><br>' +
                    'Por favor configura tus credenciales de Supabase en el c√≥digo' +
                    '</td></tr>';
                return;
            }
            
            try {
                const { data: usuarios, error } = await supabase
                    .from('usuarios')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const tbody = document.getElementById('users-table-body');
                
                if (!usuarios || usuarios.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px;">No hay usuarios registrados. Crea el primero!</td></tr>';
                    return;
                }
                
                tbody.innerHTML = '';
                usuarios.forEach((user) => {
                    const statusBadge = user.estado === 'activo' ? 
                        '<span class="badge badge-success">Activo</span>' : 
                        '<span class="badge badge-danger">Inactivo</span>';
                    
                    const roleBadge = {
                        'admin': '<span class="badge badge-danger">Administrador</span>',
                        'operador': '<span class="badge badge-info">Operador</span>',
                        'supervisor': '<span class="badge badge-warning">Supervisor</span>'
                    }[user.rol] || user.rol;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = 
                        '<td><strong>' + escapeHtml(user.nombre) + '</strong></td>' +
                        '<td>' + escapeHtml(user.email) + '</td>' +
                        '<td>' + roleBadge + '</td>' +
                        '<td>' + statusBadge + '</td>' +
                        '<td class="actions-cell"></td>';
                    
                    // Agregar botones de forma segura
                    const actionsCell = row.querySelector('.actions-cell');
                    
                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-primary btn-small';
                    editBtn.textContent = 'Editar';
                    editBtn.onclick = function() {
                        window.editUser(user.id);
                    };
                    actionsCell.appendChild(editBtn);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-danger btn-small';
                    deleteBtn.textContent = 'Eliminar';
                    deleteBtn.onclick = function() {
                        window.deleteUser(user.id);
                    };
                    actionsCell.appendChild(deleteBtn);
                    
                    // Guardar datos en el elemento para acceso posterior
                    row.dataset.userData = JSON.stringify(user);
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error cargando usuarios:', error);
                showAlert('users-alert', 'error', 'Error al cargar usuarios: ' + error.message);
            }
        }

        // Abrir modal
        window.openUserModal = function(userId = null, userData = null) {
            const modal = document.getElementById('user-modal');
            const form = document.getElementById('user-form');
            const title = document.getElementById('modal-title');
            
            currentUserId = userId;
            
            if (userId && userData) {
                title.textContent = 'Editar Usuario';
                document.getElementById('user-name').value = userData.nombre || '';
                document.getElementById('user-email').value = userData.email || '';
                document.getElementById('user-phone').value = userData.telefono || '';
                document.getElementById('user-role').value = userData.rol || '';
                document.getElementById('user-status').value = userData.estado || 'activo';
            } else {
                title.textContent = 'Nuevo Usuario';
                form.reset();
                // Establecer valor por defecto
                document.getElementById('user-status').value = 'activo';
            }
            
            modal.classList.add('active');
        };

        // Cerrar modal
        window.closeUserModal = function() {
            document.getElementById('user-modal').classList.remove('active');
            document.getElementById('user-form').reset();
            currentUserId = null;
        };

        // Editar usuario
        window.editUser = function(id) {
            // Buscar el row con este ID
            const rows = document.querySelectorAll('#users-table-body tr');
            let userData = null;
            
            rows.forEach(row => {
                if (row.dataset.userData) {
                    const data = JSON.parse(row.dataset.userData);
                    if (data.id === id) {
                        userData = data;
                    }
                }
            });
            
            if (userData) {
                window.openUserModal(id, userData);
            }
        };

        // Eliminar usuario
        window.deleteUser = async function(id) {
            if (!confirm('¬øEst√°s seguro de eliminar este usuario?')) return;
            
            try {
                const { error } = await supabase
                    .from('usuarios')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showAlert('users-alert', 'success', 'Usuario eliminado correctamente');
                loadUsers();
            } catch (error) {
                console.error('Error eliminando usuario:', error);
                showAlert('users-alert', 'error', 'Error al eliminar usuario: ' + error.message);
            }
        };

        // Guardar usuario (crear o actualizar)
        document.getElementById('user-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!supabase) {
                showAlert('users-alert', 'error', 'Supabase no est√° configurado. Por favor configura tus credenciales.');
                return;
            }
            
            const userData = {
                nombre: document.getElementById('user-name').value.trim(),
                email: document.getElementById('user-email').value.trim(),
                telefono: document.getElementById('user-phone').value.trim(),
                rol: document.getElementById('user-role').value,
                estado: document.getElementById('user-status').value,
                updated_at: new Date().toISOString()
            };

            // Validar campos
            if (!userData.nombre || !userData.email || !userData.rol || !userData.estado) {
                showAlert('users-alert', 'error', 'Por favor completa todos los campos obligatorios');
                return;
            }

            try {
                if (currentUserId) {
                    // Actualizar
                    const { error } = await supabase
                        .from('usuarios')
                        .update(userData)
                        .eq('id', currentUserId);
                    
                    if (error) throw error;
                    showAlert('users-alert', 'success', 'Usuario actualizado correctamente');
                } else {
                    // Crear
                    userData.created_at = new Date().toISOString();
                    const { error } = await supabase
                        .from('usuarios')
                        .insert([userData]);
                    
                    if (error) throw error;
                    showAlert('users-alert', 'success', 'Usuario creado correctamente');
                }
                
                window.closeUserModal();
                loadUsers();
            } catch (error) {
                console.error('Error guardando usuario:', error);
                showAlert('users-alert', 'error', 'Error al guardar usuario: ' + error.message);
            }
        });

        // Cerrar modal al hacer clic fuera
        document.getElementById('user-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                window.closeUserModal();
            }
        });

        // Funci√≥n para mostrar alertas
        function showAlert(containerId, type, message) {
            const container = document.getElementById(containerId);
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-error' : 'alert-info';
            
            container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Cargar usuarios al iniciar
        loadUsers();

        // ==================== M√ìDULO: DOMICILIARIOS ====================
        
        let currentDeliveryId = null;
        let map = null;
        let markers = {};
        let locationWatchers = {};

        // Inicializar mapa
        function initMap() {
            if (map) return;
            
            // Centro en Bogot√° por defecto
            map = L.map('map').setView([4.7110, -74.0721], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
        }

        // Cargar domiciliarios
        async function loadDeliveries() {
            if (!supabase) return;
            
            try {
                const { data: domiciliarios, error } = await supabase
                    .from('domiciliarios')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const tbody = document.getElementById('delivery-table-body');
                
                if (!domiciliarios || domiciliarios.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px;">No hay domiciliarios registrados</td></tr>';
                    return;
                }
                
                tbody.innerHTML = '';
                domiciliarios.forEach((delivery) => {
                    const statusBadge = {
                        'disponible': '<span class="badge badge-success">Disponible</span>',
                        'ocupado': '<span class="badge badge-warning">Ocupado</span>',
                        'inactivo': '<span class="badge badge-danger">Inactivo</span>'
                    }[delivery.estado] || delivery.estado;

                    const lastLocation = delivery.ubicacion ? 
                        new Date(delivery.ubicacion.timestamp).toLocaleString('es-CO') :
                        'Sin ubicaci√≥n';

                    const phoneClean = delivery.telefono.replace(/\D/g, '');
                    
                    // Crear bot√≥n de WhatsApp de forma segura
                    const whatsappBtn = document.createElement('button');
                    whatsappBtn.className = 'btn btn-whatsapp btn-small';
                    whatsappBtn.textContent = 'üí¨ WhatsApp';
                    whatsappBtn.onclick = function() {
                        window.sendWhatsApp(phoneClean, delivery.nombre);
                    };

                    const row = document.createElement('tr');
                    row.innerHTML = 
                        '<td><strong>' + escapeHtml(delivery.nombre) + '</strong></td>' +
                        '<td>' + escapeHtml(delivery.telefono) + '</td>' +
                        '<td>' + statusBadge + '</td>' +
                        '<td style="font-size: 12px;">' + escapeHtml(lastLocation) + '</td>' +
                        '<td class="actions-cell">' +
                        '</td>';
                    
                    // Agregar botones a la celda de acciones
                    const actionsCell = row.querySelector('.actions-cell');
                    actionsCell.appendChild(whatsappBtn);
                    
                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-primary btn-small';
                    editBtn.textContent = 'Editar';
                    editBtn.onclick = function() {
                        window.editDelivery(delivery.id);
                    };
                    actionsCell.appendChild(editBtn);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-danger btn-small';
                    deleteBtn.textContent = 'Eliminar';
                    deleteBtn.onclick = function() {
                        window.deleteDelivery(delivery.id);
                    };
                    actionsCell.appendChild(deleteBtn);
                    
                    row.dataset.deliveryData = JSON.stringify(delivery);
                    tbody.appendChild(row);

                    // Actualizar marcador en el mapa
                    if (delivery.ubicacion && delivery.ubicacion.lat && delivery.ubicacion.lng) {
                        updateMarker(delivery.id, delivery);
                    }
                });
            } catch (error) {
                console.error('Error cargando domiciliarios:', error);
                showAlert('delivery-alert', 'error', 'Error al cargar domiciliarios: ' + error.message);
            }
        }

        // Actualizar marcador en el mapa
        function updateMarker(id, delivery) {
            if (!map) initMap();
            
            const { lat, lng } = delivery.ubicacion;
            
            // Si ya existe el marcador, actualizarlo
            if (markers[id]) {
                markers[id].setLatLng([lat, lng]);
            } else {
                // Crear nuevo marcador
                const bgColor = delivery.estado === 'disponible' ? '#27ae60' : delivery.estado === 'ocupado' ? '#f39c12' : '#e74c3c';
                const iconHtml = document.createElement('div');
                iconHtml.style.cssText = 'background: ' + bgColor + '; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 16px;';
                iconHtml.textContent = 'üèçÔ∏è';
                
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: iconHtml.outerHTML,
                    iconSize: [30, 30]
                });

                const marker = L.marker([lat, lng], { icon }).addTo(map);
                
                const popup = document.createElement('div');
                popup.className = 'delivery-marker-popup';
                popup.innerHTML = 
                    '<strong>üèçÔ∏è ' + escapeHtml(delivery.nombre) + '</strong>' +
                    '<div style="margin-top: 5px;">' +
                    '<span class="status-dot ' + delivery.estado + '"></span>' +
                    delivery.estado.charAt(0).toUpperCase() + delivery.estado.slice(1) +
                    '</div>' +
                    '<div style="margin-top: 5px; font-size: 11px; color: #7f8c8d;">' +
                    'üìû ' + escapeHtml(delivery.telefono) +
                    '</div>' +
                    '<div style="margin-top: 5px; font-size: 11px; color: #7f8c8d;">' +
                    '‚è∞ ' + escapeHtml(new Date(delivery.ubicacion.timestamp).toLocaleString('es-CO')) +
                    '</div>';
                
                marker.bindPopup(popup);
                
                markers[id] = marker;
            }
        }

        // Enviar mensaje por WhatsApp
        window.sendWhatsApp = function(phone, name) {
            const linea1 = 'Hola ' + name + '! üëã\n\n';
            const linea2 = 'Has recibido un nuevo pedido. Por favor, comparte tu ubicaci√≥n en tiempo real para que podamos hacer seguimiento de la entrega.\n\n';
            const linea3 = 'Para compartir tu ubicaci√≥n:\n';
            const linea4 = '1Ô∏è‚É£ Abre este chat\n';
            const linea5 = '2Ô∏è‚É£ Toca el √≠cono de adjuntar (+)\n';
            const linea6 = '3Ô∏è‚É£ Selecciona "Ubicaci√≥n"\n';
            const linea7 = '4Ô∏è‚É£ Toca "Ubicaci√≥n en tiempo real"\n';
            const linea8 = '5Ô∏è‚É£ Selecciona la duraci√≥n\n\n';
            const linea9 = '¬°Gracias! üöÄ';
            
            const message = encodeURIComponent(linea1 + linea2 + linea3 + linea4 + linea5 + linea6 + linea7 + linea8 + linea9);
            
            window.open('https://wa.me/' + phone + '?text=' + message, '_blank');
        };

        // Abrir modal
        window.openDeliveryModal = function(id = null, data = null) {
            const modal = document.getElementById('delivery-modal');
            const form = document.getElementById('delivery-form');
            const title = document.getElementById('delivery-modal-title');
            
            currentDeliveryId = id;
            
            if (id && data) {
                title.textContent = 'Editar Domiciliario';
                document.getElementById('delivery-name').value = data.nombre;
                document.getElementById('delivery-phone').value = data.telefono;
                document.getElementById('delivery-status').value = data.estado;
            } else {
                title.textContent = 'Nuevo Domiciliario';
                form.reset();
            }
            
            modal.classList.add('active');
        };

        // Cerrar modal
        window.closeDeliveryModal = function() {
            document.getElementById('delivery-modal').classList.remove('active');
            document.getElementById('delivery-form').reset();
            currentDeliveryId = null;
        };

        // Editar domiciliario
        window.editDelivery = function(id) {
            const rows = document.querySelectorAll('#delivery-table-body tr');
            let deliveryData = null;
            
            rows.forEach(row => {
                if (row.dataset.deliveryData) {
                    const data = JSON.parse(row.dataset.deliveryData);
                    if (data.id === id) {
                        deliveryData = data;
                    }
                }
            });
            
            if (deliveryData) {
                window.openDeliveryModal(id, deliveryData);
            }
        };

        // Eliminar domiciliario
        window.deleteDelivery = async function(id) {
            if (!confirm('¬øEst√°s seguro de eliminar este domiciliario?')) return;
            
            try {
                const { error } = await supabase
                    .from('domiciliarios')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                // Remover marcador del mapa
                if (markers[id]) {
                    map.removeLayer(markers[id]);
                    delete markers[id];
                }
                
                showAlert('delivery-alert', 'success', 'Domiciliario eliminado correctamente');
                loadDeliveries();
            } catch (error) {
                console.error('Error eliminando domiciliario:', error);
                showAlert('delivery-alert', 'error', 'Error al eliminar domiciliario: ' + error.message);
            }
        };

        // Guardar domiciliario
        document.getElementById('delivery-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const deliveryData = {
                nombre: document.getElementById('delivery-name').value,
                telefono: document.getElementById('delivery-phone').value,
                estado: document.getElementById('delivery-status').value,
                updated_at: new Date().toISOString()
            };

            try {
                if (currentDeliveryId) {
                    // Actualizar
                    const { error } = await supabase
                        .from('domiciliarios')
                        .update(deliveryData)
                        .eq('id', currentDeliveryId);
                    
                    if (error) throw error;
                    showAlert('delivery-alert', 'success', 'Domiciliario actualizado correctamente');
                } else {
                    // Crear
                    deliveryData.created_at = new Date().toISOString();
                    deliveryData.pedidos_completados = 0;
                    const { error } = await supabase
                        .from('domiciliarios')
                        .insert([deliveryData]);
                    
                    if (error) throw error;
                    showAlert('delivery-alert', 'success', 'Domiciliario creado correctamente. Env√≠ale un WhatsApp para que comparta su ubicaci√≥n.');
                }
                
                window.closeDeliveryModal();
                loadDeliveries();
            } catch (error) {
                console.error('Error guardando domiciliario:', error);
                showAlert('delivery-alert', 'error', 'Error al guardar domiciliario: ' + error.message);
            }
        });

        // Cerrar modal al hacer clic fuera
        document.getElementById('delivery-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                window.closeDeliveryModal();
            }
        });

        // Refrescar mapa
        window.refreshMap = function() {
            loadDeliveries();
            showAlert('delivery-alert', 'success', 'Mapa actualizado');
        };

        // Inicializar mapa cuando se abre el m√≥dulo de domiciliarios
        document.querySelector('[data-module="domiciliarios"]').addEventListener('click', function() {
            setTimeout(() => {
                initMap();
                loadDeliveries();
            }, 100);
        });

        // Cargar domiciliarios peri√≥dicamente (cada 30 segundos) para actualizar ubicaciones
        setInterval(() => {
            const activeModule = document.querySelector('.module-container.active');
            if (activeModule && activeModule.id === 'module-domiciliarios') {
                loadDeliveries();
            }
        }, 30000);

        // ==================== M√ìDULO: PEDIDOS ====================
        
        let currentOrderId = null;
        let trackingMap = null;
        let trackingMarker = null;
        let trackingInterval = null;
        let allOrders = [];

        // Cargar pedidos
        async function loadOrders() {
            if (!supabase) return;
            
            try {
                const { data: pedidos, error } = await supabase
                    .from('pedidos')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const tbody = document.getElementById('orders-table-body');
                
                allOrders = pedidos || [];
                
                if (allOrders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px;">No hay pedidos registrados</td></tr>';
                    return;
                }

                renderOrders(allOrders);
            } catch (error) {
                console.error('Error cargando pedidos:', error);
                showAlert('orders-alert', 'error', 'Error al cargar pedidos: ' + error.message);
            }
        }

        // Renderizar pedidos
        function renderOrders(orders) {
            const tbody = document.getElementById('orders-table-body');
            tbody.innerHTML = '';

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px;">No hay pedidos con ese filtro</td></tr>';
                return;
            }

            orders.forEach((order) => {
                const statusBadge = {
                    'pendiente': '<span class="status-badge status-pendiente">‚è≥ Pendiente</span>',
                    'asignado': '<span class="status-badge status-asignado">üë§ Asignado</span>',
                    'en_camino': '<span class="status-badge status-en_camino">üöö En camino</span>',
                    'entregado': '<span class="status-badge status-entregado">‚úÖ Entregado</span>',
                    'cancelado': '<span class="status-badge status-cancelado">‚ùå Cancelado</span>'
                }[order.estado] || order.estado;

                const elapsedTime = order.tiempo_aceptacion ? 
                    calculateElapsedTime(order.tiempo_aceptacion) : '--';

                const deliveryPerson = order.domiciliario_nombre || 'Sin asignar';
                const orderId = order.id.substring(0, 8);

                const total = formatCurrency(order.valor_pedido + order.valor_domicilio);

                const row = document.createElement('tr');
                row.innerHTML = 
                    '<td><strong>#' + orderId + '</strong></td>' +
                    '<td>' +
                    '<strong>' + escapeHtml(order.cliente) + '</strong><br>' +
                    '<small style="color: #7f8c8d;">üìû ' + escapeHtml(order.telefono_cliente) + '</small>' +
                    '</td>' +
                    '<td style="max-width: 200px; font-size: 12px;">' + escapeHtml(order.direccion) + '</td>' +
                    '<td>' +
                    '<strong>' + total + '</strong><br>' +
                    '<small style="color: #7f8c8d;">' + (order.metodo_pago === 'efectivo' ? 'üíµ' : 'üí≥') + ' ' + escapeHtml(order.metodo_pago) + '</small>' +
                    '</td>' +
                    '<td>' + escapeHtml(deliveryPerson) + '</td>' +
                    '<td>' + statusBadge + '</td>' +
                    '<td><strong>' + elapsedTime + '</strong></td>' +
                    '<td class="actions-cell"></td>';
                
                // Agregar botones de forma segura
                const actionsCell = row.querySelector('.actions-cell');
                
                if (order.estado !== 'entregado' && order.estado !== 'cancelado') {
                    const changeBtn = document.createElement('button');
                    changeBtn.className = 'btn btn-primary btn-small';
                    changeBtn.textContent = 'Cambiar Estado';
                    changeBtn.onclick = function() {
                        window.changeOrderStatus(order.id);
                    };
                    actionsCell.appendChild(changeBtn);
                }
                
                if (order.estado === 'en_camino' && order.domiciliario_id) {
                    const trackBtn = document.createElement('button');
                    trackBtn.className = 'btn btn-success btn-small';
                    trackBtn.textContent = 'üìç Rastrear';
                    trackBtn.onclick = function() {
                        window.openTracking(order.id);
                    };
                    actionsCell.appendChild(trackBtn);
                }
                
                const viewBtn = document.createElement('button');
                viewBtn.className = 'btn btn-secondary btn-small';
                viewBtn.textContent = 'Ver';
                viewBtn.onclick = function() {
                    window.viewOrderDetails(order.id);
                };
                actionsCell.appendChild(viewBtn);
                
                if (order.estado === 'pendiente') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-danger btn-small';
                    deleteBtn.textContent = 'Eliminar';
                    deleteBtn.onclick = function() {
                        window.deleteOrder(order.id);
                    };
                    actionsCell.appendChild(deleteBtn);
                }
                
                row.dataset.orderData = JSON.stringify(order);
                tbody.appendChild(row);
            });
        }

        // Filtrar pedidos
        window.filterOrders = function() {
            const filterStatus = document.getElementById('filter-status').value;
            
            if (!filterStatus) {
                renderOrders(allOrders);
                return;
            }

            const filtered = allOrders.filter(order => order.estado === filterStatus);
            renderOrders(filtered);
        };

        // Calcular tiempo transcurrido
        function calculateElapsedTime(timestamp) {
            if (!timestamp) return '--';
            
            const now = Date.now();
            const diff = now - timestamp;
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m`;
        }

        // Formatear moneda
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(value);
        }

        // Calcular total
        window.calculateTotal = function() {
            const orderValue = parseFloat(document.getElementById('order-value').value) || 0;
            const deliveryFee = parseFloat(document.getElementById('order-delivery-fee').value) || 0;
            const total = orderValue + deliveryFee;
            document.getElementById('order-total').value = formatCurrency(total);
        };

        // Cargar domiciliarios disponibles
        async function loadAvailableDeliveries() {
            if (!supabase) return;
            
            try {
                const { data: domiciliarios, error } = await supabase
                    .from('domiciliarios')
                    .select('*')
                    .in('estado', ['disponible', 'ocupado']);
                
                if (error) throw error;
                
                const select = document.getElementById('order-delivery-person');
                select.innerHTML = '<option value="">Sin asignar</option>';
                
                domiciliarios.forEach((delivery) => {
                    const statusText = delivery.estado === 'disponible' ? '‚úÖ Disponible' : '‚ö†Ô∏è Ocupado';
                    const option = document.createElement('option');
                    option.value = delivery.id;
                    option.dataset.name = delivery.nombre;
                    option.dataset.phone = delivery.telefono;
                    option.textContent = delivery.nombre + ' - ' + statusText;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargando domiciliarios:', error);
            }
        }

        // Abrir modal de pedido
        window.openOrderModal = async function(id = null) {
            const modal = document.getElementById('order-modal');
            const form = document.getElementById('order-form');
            const title = document.getElementById('order-modal-title');
            
            currentOrderId = id;
            await loadAvailableDeliveries();
            
            if (id) {
                // Cargar datos del pedido para editar
                const order = allOrders.find(o => o.id === id);
                if (order) {
                    title.textContent = 'Editar Pedido';
                    document.getElementById('order-customer-name').value = order.cliente;
                    document.getElementById('order-customer-phone').value = order.telefonoCliente;
                    document.getElementById('order-address').value = order.direccion;
                    document.getElementById('order-value').value = order.valorPedido;
                    document.getElementById('order-delivery-fee').value = order.valorDomicilio;
                    document.getElementById('order-payment-method').value = order.metodoPago;
                    document.getElementById('order-delivery-person').value = order.domiciliarioId || '';
                    document.getElementById('order-notes').value = order.notas || '';
                    calculateTotal();
                }
            } else {
                title.textContent = 'Nuevo Pedido';
                form.reset();
            }
            
            modal.classList.add('active');
        };

        // Cerrar modal de pedido
        window.closeOrderModal = function() {
            document.getElementById('order-modal').classList.remove('active');
            document.getElementById('order-form').reset();
            currentOrderId = null;
        };

        // Guardar pedido
        document.getElementById('order-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const deliverySelect = document.getElementById('order-delivery-person');
            const selectedOption = deliverySelect.options[deliverySelect.selectedIndex];
            
            const orderData = {
                cliente: document.getElementById('order-customer-name').value,
                telefono_cliente: document.getElementById('order-customer-phone').value,
                direccion: document.getElementById('order-address').value,
                valor_pedido: parseFloat(document.getElementById('order-value').value),
                valor_domicilio: parseFloat(document.getElementById('order-delivery-fee').value),
                metodo_pago: document.getElementById('order-payment-method').value,
                domiciliario_id: deliverySelect.value || null,
                domiciliario_nombre: selectedOption.dataset.name || null,
                domiciliario_telefono: selectedOption.dataset.phone || null,
                notas: document.getElementById('order-notes').value || '',
                updated_at: new Date().toISOString()
            };

            // Determinar estado
            if (!orderData.domiciliario_id) {
                orderData.estado = 'pendiente';
            } else if (currentOrderId) {
                // Mantener estado actual si est√° editando
                const currentOrder = allOrders.find(o => o.id === currentOrderId);
                orderData.estado = currentOrder.estado;
            } else {
                orderData.estado = 'asignado';
                orderData.tiempo_aceptacion = Date.now();
            }

            try {
                if (currentOrderId) {
                    // Actualizar
                    const { error } = await supabase
                        .from('pedidos')
                        .update(orderData)
                        .eq('id', currentOrderId);
                    
                    if (error) throw error;
                    showAlert('orders-alert', 'success', 'Pedido actualizado correctamente');
                } else {
                    // Crear
                    orderData.created_at = new Date().toISOString();
                    const { error } = await supabase
                        .from('pedidos')
                        .insert([orderData]);
                    
                    if (error) throw error;
                    showAlert('orders-alert', 'success', 'Pedido creado correctamente');
                }
                
                window.closeOrderModal();
                loadOrders();
            } catch (error) {
                console.error('Error guardando pedido:', error);
                showAlert('orders-alert', 'error', 'Error al guardar pedido: ' + error.message);
            }
        });

        // Cambiar estado del pedido
        window.changeOrderStatus = async function(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            const nextStatus = {
                'pendiente': 'asignado',
                'asignado': 'en_camino',
                'en_camino': 'entregado'
            }[order.estado];

            if (!nextStatus) return;

            const statusNames = {
                'asignado': 'Asignado',
                'en_camino': 'En camino',
                'entregado': 'Entregado'
            };

            if (!confirm('¬øCambiar estado a ' + String.fromCharCode(34) + statusNames[nextStatus] + String.fromCharCode(34) + '?')) return;

            try {
                const updateData = {
                    estado: nextStatus,
                    fechaActualizacion: serverTimestamp()
                };

                // Si pasa a "asignado" y no tiene tiempo de aceptaci√≥n
                if (nextStatus === 'asignado' && !order.tiempoAceptacion) {
                    updateData.tiempoAceptacion = Date.now();
                }

                // Si pasa a "entregado", guardar tiempo de entrega
                if (nextStatus === 'entregado') {
                    updateData.tiempoEntrega = Date.now();
                }

                await updateDoc(doc(db, 'pedidos', orderId), updateData);
                showAlert('orders-alert', 'success', 'Estado actualizado correctamente');
                loadOrders();
            } catch (error) {
                console.error('Error cambiando estado:', error);
                showAlert('orders-alert', 'error', 'Error al cambiar estado');
            }
        };

        // Ver detalles del pedido
        window.viewOrderDetails = function(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            const line1 = 'üìã DETALLES DEL PEDIDO #' + orderId.substring(0, 8) + '\n\n';
            const line2 = 'üë§ Cliente: ' + order.cliente + '\n';
            const line3 = 'üìû Tel√©fono: ' + order.telefono_cliente + '\n';
            const line4 = 'üìç Direcci√≥n: ' + order.direccion + '\n\n';
            const line5 = 'üí∞ Valor pedido: ' + formatCurrency(order.valor_pedido) + '\n';
            const line6 = 'üöö Valor domicilio: ' + formatCurrency(order.valor_domicilio) + '\n';
            const line7 = 'üíµ Total: ' + formatCurrency(order.valor_pedido + order.valor_domicilio) + '\n';
            const line8 = 'üí≥ M√©todo de pago: ' + order.metodo_pago + '\n\n';
            const line9 = 'üèçÔ∏è Domiciliario: ' + (order.domiciliario_nombre || 'Sin asignar') + '\n';
            const line10 = 'üìä Estado: ' + order.estado + '\n';
            const line11 = '‚è±Ô∏è Tiempo: ' + (order.tiempo_aceptacion ? calculateElapsedTime(order.tiempo_aceptacion) : '--') + '\n\n';
            const line12 = 'üìù Notas: ' + (order.notas || 'Sin notas');
            
            const details = line1 + line2 + line3 + line4 + line5 + line6 + line7 + line8 + line9 + line10 + line11 + line12;

            alert(details);
        };

        // Eliminar pedido
        window.deleteOrder = async function(orderId) {
            if (!confirm('¬øEst√°s seguro de eliminar este pedido?')) return;
            
            try {
                await deleteDoc(doc(db, 'pedidos', orderId));
                showAlert('orders-alert', 'success', 'Pedido eliminado correctamente');
                loadOrders();
            } catch (error) {
                console.error('Error eliminando pedido:', error);
                showAlert('orders-alert', 'error', 'Error al eliminar pedido');
            }
        };

        // Abrir modal de seguimiento
        window.openTracking = async function(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order || !order.domiciliario_id) return;

            const modal = document.getElementById('tracking-modal');
            modal.classList.add('active');

            // Mostrar informaci√≥n del pedido
            const infoDiv = document.getElementById('tracking-info');
            infoDiv.innerHTML = '';
            
            const orderDetailDiv = document.createElement('div');
            orderDetailDiv.className = 'order-detail';
            
            orderDetailDiv.innerHTML = 
                '<div class="order-detail-item">' +
                '<strong>Cliente</strong>' +
                '<span>' + escapeHtml(order.cliente) + '</span>' +
                '</div>' +
                '<div class="order-detail-item">' +
                '<strong>Direcci√≥n</strong>' +
                '<span style="font-size: 13px;">' + escapeHtml(order.direccion) + '</span>' +
                '</div>' +
                '<div class="order-detail-item">' +
                '<strong>Domiciliario</strong>' +
                '<span>' + escapeHtml(order.domiciliario_nombre) + '</span>' +
                '</div>' +
                '<div class="order-detail-item">' +
                '<strong>Total</strong>' +
                '<span>' + formatCurrency(order.valor_pedido + order.valor_domicilio) + '</span>' +
                '</div>';
            
            infoDiv.appendChild(orderDetailDiv);

            // Inicializar mapa
            if (!trackingMap) {
                trackingMap = L.map('tracking-map').setView([4.7110, -74.0721], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(trackingMap);
            }

            // Actualizar ubicaci√≥n
            updateTracking(order.domiciliario_id, order);
            
            // Actualizar cada 10 segundos
            trackingInterval = setInterval(() => {
                updateTracking(order.domiciliario_id, order);
            }, 10000);
        };

        // Actualizar seguimiento
        async function updateTracking(deliveryId, order) {
            try {
                const { data: delivery, error } = await supabase
                    .from('domiciliarios')
                    .select('*')
                    .eq('id', deliveryId)
                    .single();

                if (error) throw error;

                if (delivery && delivery.ubicacion) {
                    const { lat, lng } = delivery.ubicacion;
                    
                    // Actualizar o crear marcador
                    if (trackingMarker) {
                        trackingMarker.setLatLng([lat, lng]);
                    } else {
                        const iconHtml = document.createElement('div');
                        iconHtml.style.cssText = 'background: #3498db; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 16px;';
                        iconHtml.textContent = 'üèçÔ∏è';
                        
                        const icon = L.divIcon({
                            className: 'custom-marker',
                            html: iconHtml.outerHTML,
                            iconSize: [30, 30]
                        });

                        trackingMarker = L.marker([lat, lng], { icon }).addTo(trackingMap);
                        
                        const popup = document.createElement('div');
                        popup.innerHTML = 
                            '<strong>üèçÔ∏è ' + escapeHtml(delivery.nombre) + '</strong><br>' +
                            '<small>√öltima actualizaci√≥n: ' + escapeHtml(new Date(delivery.ubicacion.timestamp).toLocaleTimeString('es-CO')) + '</small>';
                        
                        trackingMarker.bindPopup(popup);
                    }

                    // Centrar mapa
                    trackingMap.setView([lat, lng], 15);

                    // Actualizar estado y tiempo
                    document.getElementById('tracking-status').innerHTML = 
                        '<span class="status-badge status-en_camino">üöö En camino</span>';
                    document.getElementById('tracking-time').textContent = 
                        calculateElapsedTime(order.tiempo_aceptacion);
                } else {
                    document.getElementById('tracking-status').innerHTML = 
                        '<span class="badge badge-warning">‚ö†Ô∏è Sin ubicaci√≥n disponible</span>';
                }
            } catch (error) {
                console.error('Error actualizando seguimiento:', error);
            }
        }

        // Cerrar modal de seguimiento
        window.closeTrackingModal = function() {
            document.getElementById('tracking-modal').classList.remove('active');
            
            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
            }
            
            if (trackingMarker && trackingMap) {
                trackingMap.removeLayer(trackingMarker);
                trackingMarker = null;
            }
        };

        // Cerrar modales al hacer clic fuera
        document.getElementById('order-modal').addEventListener('click', function(e) {
            if (e.target === this) window.closeOrderModal();
        });

        document.getElementById('tracking-modal').addEventListener('click', function(e) {
            if (e.target === this) window.closeTrackingModal();
        });

        // Inicializar cuando se abre el m√≥dulo de pedidos
        document.querySelector('[data-module="pedidos"]').addEventListener('click', function() {
            setTimeout(() => {
                loadOrders();
            }, 100);
        });

        // Actualizar pedidos peri√≥dicamente (cada 30 segundos)
        setInterval(() => {
            const activeModule = document.querySelector('.module-container.active');
            if (activeModule && activeModule.id === 'module-pedidos') {
                loadOrders();
            }
        }, 30000);

        // ==================== M√ìDULO: DASHBOARD ====================
        
        let statusChart = null;
        let incomeChart = null;

        // Cargar dashboard
        async function loadDashboard() {
            if (!supabase) return;

            try {
                // Cargar pedidos
                const { data: pedidos, error: ordersError } = await supabase
                    .from('pedidos')
                    .select('*');
                
                if (ordersError) throw ordersError;

                // Cargar domiciliarios
                const { data: domiciliarios, error: deliveriesError } = await supabase
                    .from('domiciliarios')
                    .select('*');
                
                if (deliveriesError) throw deliveriesError;

                // Calcular estad√≠sticas
                calculateStats(pedidos || [], domiciliarios || []);
                renderTopDeliveries(pedidos || [], domiciliarios || []);
                renderRecentOrders(pedidos || []);
                renderStatusChart(pedidos || []);
                renderIncomeChart(pedidos || []);

            } catch (error) {
                console.error('Error cargando dashboard:', error);
            }
        }

        // Calcular estad√≠sticas
        function calculateStats(orders, deliveries) {
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const weekStart = todayStart - (6 * 24 * 60 * 60 * 1000);
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).getTime();

            // Pedidos hoy
            const todayOrders = orders.filter(o => {
                const orderDate = o.fechaCreacion?.toDate ? o.fechaCreacion.toDate().getTime() : Date.now();
                return orderDate >= todayStart;
            });

            // Pedidos semana
            const weekOrders = orders.filter(o => {
                const orderDate = o.fechaCreacion?.toDate ? o.fechaCreacion.toDate().getTime() : Date.now();
                return orderDate >= weekStart;
            });

            // Pedidos mes
            const monthOrders = orders.filter(o => {
                const orderDate = o.fechaCreacion?.toDate ? o.fechaCreacion.toDate().getTime() : Date.now();
                return orderDate >= monthStart;
            });

            // Ingresos del mes
            const monthIncome = monthOrders.reduce((sum, order) => {
                return sum + (order.valorPedido || 0) + (order.valorDomicilio || 0);
            }, 0);

            // Domiciliarios activos (disponibles u ocupados)
            const activeDeliveries = deliveries.filter(d => 
                d.estado === 'disponible' || d.estado === 'ocupado'
            ).length;

            // Tiempo promedio de entrega
            const deliveredOrders = orders.filter(o => o.estado === 'entregado' && o.tiempoAceptacion && o.tiempoEntrega);
            let avgTime = '--';
            if (deliveredOrders.length > 0) {
                const totalTime = deliveredOrders.reduce((sum, order) => {
                    return sum + (order.tiempoEntrega - order.tiempoAceptacion);
                }, 0);
                const avgMinutes = Math.round((totalTime / deliveredOrders.length) / (1000 * 60));
                avgTime = `${Math.floor(avgMinutes / 60)}h ${avgMinutes % 60}m`;
            }

            // Pedidos activos (asignado o en camino)
            const activeOrders = orders.filter(o => 
                o.estado === 'asignado' || o.estado === 'en_camino'
            ).length;

            // Tasa de √©xito
            const completedOrders = orders.filter(o => o.estado === 'entregado').length;
            const totalOrders = orders.length;
            const successRate = totalOrders > 0 ? Math.round((completedOrders / totalOrders) * 100) : 0;

            // Actualizar UI
            document.getElementById('stat-today').textContent = todayOrders.length;
            document.getElementById('stat-week').textContent = weekOrders.length;
            document.getElementById('stat-month').textContent = monthOrders.length;
            document.getElementById('stat-income').textContent = formatCurrency(monthIncome);
            document.getElementById('stat-active-delivery').textContent = activeDeliveries;
            document.getElementById('stat-avg-time').textContent = avgTime;
            document.getElementById('stat-active-orders').textContent = activeOrders;
            document.getElementById('stat-success-rate').textContent = successRate + '%';
        }

        // Renderizar top domiciliarios
        function renderTopDeliveries(orders, deliveries) {
            const deliveryStats = {};

            // Calcular estad√≠sticas por domiciliario
            orders.forEach(order => {
                if (order.domiciliario_id && order.estado === 'entregado') {
                    if (!deliveryStats[order.domiciliario_id]) {
                        deliveryStats[order.domiciliario_id] = {
                            name: order.domiciliario_nombre || 'Desconocido',
                            completed: 0,
                            totalTime: 0,
                            count: 0
                        };
                    }
                    deliveryStats[order.domiciliario_id].completed++;
                    
                    if (order.tiempo_aceptacion && order.tiempo_entrega) {
                        const time = order.tiempo_entrega - order.tiempo_aceptacion;
                        deliveryStats[order.domiciliario_id].totalTime += time;
                        deliveryStats[order.domiciliario_id].count++;
                    }
                }
            });

            // Convertir a array y ordenar
            const topDeliveries = Object.entries(deliveryStats)
                .map(([id, stats]) => ({
                    ...stats,
                    avgTime: stats.count > 0 ? Math.round(stats.totalTime / stats.count / (1000 * 60)) : 0
                }))
                .sort((a, b) => b.completed - a.completed)
                .slice(0, 5);

            // Renderizar
            const container = document.getElementById('top-deliveries-container');
            
            if (topDeliveries.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 30px; color: #7f8c8d;">No hay datos suficientes</div>';
                return;
            }

            container.innerHTML = '';
            topDeliveries.forEach((delivery, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : (index + 1) + '.';
                
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #ecf0f1;';
                
                itemDiv.innerHTML = 
                    '<div style="display: flex; align-items: center; gap: 15px;">' +
                    '<span style="font-size: 24px;">' + medal + '</span>' +
                    '<div>' +
                    '<strong style="color: #2c3e50;">' + escapeHtml(delivery.name) + '</strong>' +
                    '<div style="font-size: 12px; color: #7f8c8d; margin-top: 2px;">' +
                    'Tiempo promedio: ' + delivery.avgTime + 'min' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '<div style="text-align: right;">' +
                    '<div style="font-size: 24px; font-weight: bold; color: #27ae60;">' + delivery.completed + '</div>' +
                    '<div style="font-size: 11px; color: #7f8c8d;">entregas</div>' +
                    '</div>';
                
                container.appendChild(itemDiv);
            });
        }

        // Renderizar pedidos recientes
        function renderRecentOrders(orders) {
            const tbody = document.getElementById('recent-orders-table');
            const recentOrders = orders
                .sort((a, b) => {
                    const dateA = a.fechaCreacion?.toDate ? a.fechaCreacion.toDate().getTime() : 0;
                    const dateB = b.fechaCreacion?.toDate ? b.fechaCreacion.toDate().getTime() : 0;
                    return dateB - dateA;
                })
                .slice(0, 10);

            if (recentOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px;">No hay pedidos</td></tr>';
                return;
            }

            tbody.innerHTML = recentOrders.map(order => {
                const statusBadge = {
                    'pendiente': '<span class="status-badge status-pendiente">‚è≥ Pendiente</span>',
                    'asignado': '<span class="status-badge status-asignado">üë§ Asignado</span>',
                    'en_camino': '<span class="status-badge status-en_camino">üöö En camino</span>',
                    'entregado': '<span class="status-badge status-entregado">‚úÖ Entregado</span>',
                    'cancelado': '<span class="status-badge status-cancelado">‚ùå Cancelado</span>'
                }[order.estado] || order.estado;

                const elapsedTime = order.tiempoAceptacion ? calculateElapsedTime(order.tiempoAceptacion) : '--';
                const total = formatCurrency(order.valorPedido + order.valorDomicilio);
                const orderId = order.id.substring(0, 8);
                const deliveryName = order.domiciliarioNombre || 'Sin asignar';

                return '<tr>' +
                    '<td><strong>#' + orderId + '</strong></td>' +
                    '<td>' + order.cliente + '</td>' +
                    '<td>' + total + '</td>' +
                    '<td>' + deliveryName + '</td>' +
                    '<td>' + statusBadge + '</td>' +
                    '<td>' + elapsedTime + '</td>' +
                    '</tr>';
            }).join('');
        }

        // Renderizar gr√°fico de estados
        function renderStatusChart(orders) {
            const statusCount = {
                pendiente: 0,
                asignado: 0,
                en_camino: 0,
                entregado: 0,
                cancelado: 0
            };

            orders.forEach(order => {
                if (statusCount[order.estado] !== undefined) {
                    statusCount[order.estado]++;
                }
            });

            const ctx = document.getElementById('status-chart');
            
            if (statusChart) {
                statusChart.destroy();
            }

            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pendiente', 'Asignado', 'En Camino', 'Entregado', 'Cancelado'],
                    datasets: [{
                        data: [
                            statusCount.pendiente,
                            statusCount.asignado,
                            statusCount.en_camino,
                            statusCount.entregado,
                            statusCount.cancelado
                        ],
                        backgroundColor: [
                            '#f39c12',
                            '#3498db',
                            '#2ecc71',
                            '#27ae60',
                            '#e74c3c'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Renderizar gr√°fico de ingresos
        function renderIncomeChart(orders) {
            const last7Days = [];
            const incomeByDay = {};
            
            // Preparar √∫ltimos 7 d√≠as
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateKey = date.toISOString().split('T')[0];
                const dateLabel = date.toLocaleDateString('es-CO', { weekday: 'short', day: 'numeric' });
                last7Days.push({ key: dateKey, label: dateLabel });
                incomeByDay[dateKey] = 0;
            }

            // Calcular ingresos por d√≠a
            orders.forEach(order => {
                if (order.estado === 'entregado' && order.fechaCreacion?.toDate) {
                    const orderDate = order.fechaCreacion.toDate();
                    const dateKey = orderDate.toISOString().split('T')[0];
                    if (incomeByDay[dateKey] !== undefined) {
                        incomeByDay[dateKey] += (order.valorPedido || 0) + (order.valorDomicilio || 0);
                    }
                }
            });

            const ctx = document.getElementById('income-chart');
            
            if (incomeChart) {
                incomeChart.destroy();
            }

            incomeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days.map(d => d.label),
                    datasets: [{
                        label: 'Ingresos',
                        data: last7Days.map(d => incomeByDay[d.key]),
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: '#3498db'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '
</html> + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Inicializar cuando se abre el m√≥dulo de dashboard
        document.querySelector('[data-module="dashboard"]').addEventListener('click', function() {
            setTimeout(() => {
                loadDashboard();
            }, 100);
        });

        // Actualizar dashboard peri√≥dicamente (cada 60 segundos)
        setInterval(() => {
            const activeModule = document.querySelector('.module-container.active');
            if (activeModule && activeModule.id === 'module-dashboard') {
                loadDashboard();
            }
        }, 60000);
    </script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</body>
</html>