<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluxi - Domiciliario</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .login-container {
            padding: 30px 20px;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            font-size: 60px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input.error {
            border-color: #e74c3c;
        }

        .form-hint {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .hidden {
            display: none !important;
        }

        .content {
            padding: 20px;
        }

        .status-bar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-item {
            text-align: center;
        }

        .status-item .label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .status-item .value {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-indicator.active {
            background: #27ae60;
            box-shadow: 0 0 10px #27ae60;
        }

        .status-indicator.inactive {
            background: #e74c3c;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .order-card {
            background: white;
            border: 2px solid #ecf0f1;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .order-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .order-id {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }

        .order-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .order-status.pendiente {
            background: #fff3cd;
            color: #856404;
        }

        .order-status.asignado {
            background: #d1ecf1;
            color: #0c5460;
        }

        .order-status.en_camino {
            background: #cce5ff;
            color: #004085;
        }

        .order-detail {
            margin-bottom: 15px;
        }

        .order-detail-row {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .order-detail-row:last-child {
            border-bottom: none;
        }

        .order-detail-label {
            font-size: 13px;
            color: #7f8c8d;
            width: 100px;
            flex-shrink: 0;
        }

        .order-detail-value {
            font-size: 14px;
            color: #2c3e50;
            font-weight: 600;
            flex: 1;
        }

        .timer-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .timer-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .timer-value {
            font-size: 48px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .empty-state-subtext {
            font-size: 14px;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .action-buttons.single {
            grid-template-columns: 1fr;
        }

        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .alert {
            animation: slideIn 0.3s ease-out;
        }

        .new-order-badge {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
            z-index: 1000;
            animation: pulse 1s infinite;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 12px;
        }

        .login-help {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 13px;
            color: #495057;
        }

        .login-help strong {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .login-help ul {
            margin: 0;
            padding-left: 20px;
        }

        .login-help li {
            margin: 5px 0;
        }

        .location-control {
            background: white;
            border: 2px solid #ecf0f1;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .location-control.active {
            border-color: #27ae60;
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.05) 0%, rgba(39, 174, 96, 0.1) 100%);
        }

        .location-control.inactive {
            border-color: #e74c3c;
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.05) 0%, rgba(231, 76, 60, 0.1) 100%);
        }

        .location-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .location-title {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .location-message {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .location-message.success {
            color: #27ae60;
        }

        .location-message.error {
            color: #e74c3c;
        }

        .btn-location {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-location.activate {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
        }

        .btn-location.activate:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-location.deactivate {
            background: #95a5a6;
            color: white;
        }

        .btn-location:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .location-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: rgba(39, 174, 96, 0.1);
            border-radius: 8px;
            font-size: 13px;
            color: #27ae60;
            margin-top: 10px;
        }

        .location-warning {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 8px;
            font-size: 13px;
            color: #e74c3c;
            margin-bottom: 15px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="login-screen">
            <div class="header">
                <h1>üöÄ Fluxi</h1>
                <div class="subtitle">App para Domiciliarios</div>
            </div>
            <div class="login-container">
                <div class="logo">üèçÔ∏è</div>
                <div id="login-alert"></div>
                <form id="login-form">
                    <div class="form-group">
                        <label>N√∫mero de Tel√©fono</label>
                        <input type="tel" id="login-phone" required placeholder="+573001234567" value="+57">
                        <div class="form-hint">Formato: +57 seguido de 10 d√≠gitos (Ej: +573001234567)</div>
                    </div>
                    <button type="submit" class="btn btn-primary" id="login-btn">Iniciar Sesi√≥n</button>
                </form>

                <div class="login-help">
                    <strong>üí° ¬øNo puedes ingresar?</strong>
                    <ul>
                        <li>Aseg√∫rate de usar el n√∫mero registrado exactamente como fue creado</li>
                        <li>Debe incluir +57 seguido de 10 d√≠gitos</li>
                        <li>No uses espacios ni guiones</li>
                        <li>Ejemplo correcto: +573001234567</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Main App Screen -->
        <div id="app-screen" class="hidden">
            <div class="header">
                <button class="logout-btn" id="logout-btn">Salir</button>
                <h1>üèçÔ∏è <span id="delivery-name">Domiciliario</span></h1>
                <div class="subtitle">
                    <span class="status-indicator" id="location-indicator"></span>
                    <span id="location-status">Ubicaci√≥n desactivada</span>
                </div>
            </div>

            <div class="content">
                <!-- Location Control -->
                <div id="location-control" class="location-control inactive">
                    <div class="location-header">
                        <div class="location-title">
                            <span id="location-icon">üìç</span>
                            <span>Control de Ubicaci√≥n</span>
                        </div>
                        <span class="status-indicator inactive" id="location-indicator-main"></span>
                    </div>
                    
                    <div id="location-warning" class="location-warning">
                        <span>‚ö†Ô∏è</span>
                        <div>
                            <strong>Ubicaci√≥n desactivada</strong><br>
                            Debes activar tu ubicaci√≥n para poder aceptar pedidos. El cliente necesita ver d√≥nde est√°s en tiempo real.
                        </div>
                    </div>
                    
                    <div id="location-message" class="location-message">
                        Toca el bot√≥n para compartir tu ubicaci√≥n
                    </div>
                    
                    <button id="btn-toggle-location" class="btn-location activate" onclick="window.toggleLocation()">
                        <span id="location-btn-icon">üìç</span>
                        <span id="location-btn-text">Activar Ubicaci√≥n</span>
                    </button>
                    
                    <div id="location-info" class="location-info hidden">
                        <span>‚úÖ</span>
                        <div>
                            <strong>Ubicaci√≥n compartida</strong><br>
                            <span id="location-status-detail">Actualizado: --:--</span>
                        </div>
                    </div>
                </div>

                <div class="status-bar">
                    <div class="status-item">
                        <div class="label">Pedidos Hoy</div>
                        <div class="value" id="orders-today">0</div>
                    </div>
                    <div class="status-item">
                        <div class="label">Completados</div>
                        <div class="value" id="orders-completed">0</div>
                    </div>
                    <div class="status-item">
                        <div class="label">En Curso</div>
                        <div class="value" id="orders-active">0</div>
                    </div>
                </div>

                <div id="alert-container"></div>

                <!-- Active Order Section -->
                <div id="active-order-container" class="hidden">
                    <h2 style="margin-bottom: 15px; color: #2c3e50;">üì¶ Pedido Activo</h2>
                    
                    <div class="timer-display">
                        <div class="timer-label">‚è±Ô∏è Tiempo Transcurrido</div>
                        <div class="timer-value" id="timer-display">00:00:00</div>
                    </div>

                    <div id="active-order-card"></div>
                </div>

                <!-- Available Orders Section -->
                <div id="available-orders-container">
                    <h2 style="margin-bottom: 15px; color: #2c3e50;">üìã Pedidos Disponibles</h2>
                    <div id="orders-list"></div>
                </div>
            </div>

            <div class="footer">
                Fluxi ¬© 2025 - Sistema de Domicilios
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const SUPABASE_URL = 'https://lbifbexhmvbanvrjfglp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxiaWZiZXhobXZiYW52cmpmZ2xwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5Mjg5MDQsImV4cCI6MjA3NjUwNDkwNH0.ZXjCv4DkNobkn3IDK9wYBjjOV55Bf_UwcSxhkt6YqGo';

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentDelivery = null;
        let activeOrder = null;
        let locationWatchId = null;
        let locationUpdateInterval = null;
        let timerInterval = null;
        let timerStartTime = null;
        let realtimeChannel = null;
        let isLocationActive = false; // Nueva variable para trackear estado de ubicaci√≥n
        let locationUpdateCount = 0; // NUEVO: Contador de actualizaciones de ubicaci√≥n

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alert-container') || document.getElementById('login-alert');
            const alertClass = `alert-${type}`;
            container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        function validatePhone(phone) {
            // Eliminar espacios en blanco
            phone = phone.trim();
            
            // Verificar que empiece con +57
            if (!phone.startsWith('+57')) {
                return { valid: false, error: 'El n√∫mero debe comenzar con +57' };
            }
            
            // Verificar que tenga exactamente 13 caracteres (+57 + 10 d√≠gitos)
            if (phone.length !== 13) {
                return { valid: false, error: 'El n√∫mero debe tener 10 d√≠gitos despu√©s de +57' };
            }
            
            // Verificar que todos los caracteres despu√©s de +57 sean d√≠gitos
            const digits = phone.substring(3);
            if (!/^\d{10}$/.test(digits)) {
                return { valid: false, error: 'El n√∫mero debe contener solo d√≠gitos despu√©s de +57' };
            }
            
            return { valid: true, phone: phone };
        }

        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('No se pudo reproducir sonido');
            }
        }

        function showNewOrderNotification(order) {
            showAlert(`üéâ ¬°Nuevo pedido asignado! #${order.id.substring(0, 8)} - ${order.cliente}`, 'success');
            
            const badge = document.createElement('div');
            badge.className = 'new-order-badge';
            badge.textContent = 'üÜï Nuevo Pedido';
            document.body.appendChild(badge);
            
            setTimeout(() => badge.remove(), 5000);
            
            playNotificationSound();

            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200]);
            }

            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Fluxi - Nuevo Pedido', {
                    body: `Pedido de ${order.cliente}\nTotal: ${formatCurrency(order.valor_pedido + order.valor_domicilio)}`,
                    icon: 'üèçÔ∏è',
                    badge: 'üì¶'
                });
            }
        }

        function setupRealtimeSubscription() {
            if (realtimeChannel) {
                supabase.removeChannel(realtimeChannel);
            }

            realtimeChannel = supabase
                .channel('pedidos-changes')
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'pedidos'
                    },
                    async (payload) => {
                        console.log('Cambio detectado:', payload);
                        
                        if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') {
                            const newOrder = payload.new;
                            
                            if (newOrder.domiciliario_id === currentDelivery.id && 
                                newOrder.estado === 'asignado' &&
                                (!activeOrder || activeOrder.id !== newOrder.id)) {
                                showNewOrderNotification(newOrder);
                            }
                        }
                        
                        await loadOrders();
                    }
                )
                .subscribe();
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('es-CO', { 
                style: 'currency', 
                currency: 'COP', 
                minimumFractionDigits: 0 
            }).format(value);
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function startTimer(startTime = null) {
            if (timerInterval) return;
            
            // Si se proporciona un tiempo de inicio, usarlo; sino, usar el tiempo actual
            timerStartTime = startTime || Date.now();
            
            // Actualizar inmediatamente
            const elapsed = Math.floor((Date.now() - timerStartTime) / 1000);
            document.getElementById('timer-display').textContent = formatTime(elapsed);
            
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - timerStartTime) / 1000);
                document.getElementById('timer-display').textContent = formatTime(elapsed);
            }, 1000);
            
            console.log('‚è±Ô∏è Temporizador iniciado desde:', new Date(timerStartTime).toLocaleTimeString());
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            timerStartTime = null;
            document.getElementById('timer-display').textContent = '00:00:00';
        }

        function requestLocationPermission() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocalizaci√≥n no soportada'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    () => resolve(true),
                    (error) => reject(error),
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }

        function updateLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocalizaci√≥n no disponible'));
                    return;
                }
                
                if (!currentDelivery) {
                    reject(new Error('No hay domiciliario activo'));
                    return;
                }

                console.log('üîÑ Solicitando ubicaci√≥n GPS...');

                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        try {
                            const locationData = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                timestamp: new Date().toISOString(),
                                accuracy: position.coords.accuracy,
                                speed: position.coords.speed,
                                heading: position.coords.heading
                            };

                            console.log('üìç Ubicaci√≥n GPS obtenida:', {
                                lat: locationData.lat.toFixed(6),
                                lng: locationData.lng.toFixed(6),
                                accuracy: Math.round(locationData.accuracy) + 'm',
                                timestamp: locationData.timestamp
                            });

                            console.log('üíæ Guardando en base de datos...');
                            const { data: updateResult, error: updateError } = await supabase
                                .from('domiciliarios')
                                .update({ 
                                    ubicacion: locationData,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', currentDelivery.id)
                                .select();

                            if (updateError) {
                                console.error('‚ùå Error al guardar ubicaci√≥n:', updateError);
                                throw updateError;
                            }

                            console.log('‚úÖ Ubicaci√≥n guardada exitosamente en BD:', updateResult);

                            // Verificar que se guard√≥ correctamente
                            const { data: verifyData, error: verifyError } = await supabase
                                .from('domiciliarios')
                                .select('ubicacion')
                                .eq('id', currentDelivery.id)
                                .single();

                            if (verifyData && verifyData.ubicacion) {
                                console.log('‚úÖ Verificaci√≥n: Ubicaci√≥n confirmada en BD:', {
                                    lat: verifyData.ubicacion.lat.toFixed(6),
                                    lng: verifyData.ubicacion.lng.toFixed(6),
                                    timestamp: verifyData.ubicacion.timestamp
                                });
                            } else {
                                console.warn('‚ö†Ô∏è Advertencia: No se pudo verificar la ubicaci√≥n en BD');
                            }

                            // Incrementar contador de actualizaciones
                            locationUpdateCount++;

                            document.getElementById('location-indicator').classList.add('active');
                            document.getElementById('location-indicator').classList.remove('inactive');
                            
                            const timeStr = new Date().toLocaleTimeString('es-CO', { 
                                hour: '2-digit', 
                                minute: '2-digit',
                                second: '2-digit'
                            });
                            
                            document.getElementById('location-status').textContent = 
                                `Ubicaci√≥n activa - Actualizado: ${timeStr} (${locationUpdateCount} actualizaciones)`;
                            
                            // Actualizar UI del control de ubicaci√≥n
                            updateLocationUI(true);
                            
                            console.log(`üìç [${locationUpdateCount}] Ubicaci√≥n actualizada completamente:`, {
                                lat: locationData.lat.toFixed(6),
                                lng: locationData.lng.toFixed(6),
                                accuracy: Math.round(locationData.accuracy) + 'm',
                                time: timeStr
                            });
                            
                            resolve(locationData);
                        } catch (error) {
                            console.error('‚ùå Error actualizando ubicaci√≥n:', error);
                            reject(error);
                        }
                    },
                    (error) => {
                        console.error('‚ùå Error de geolocalizaci√≥n:', error);
                        let errorMessage = 'Error al obtener ubicaci√≥n. ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += 'Permisos de ubicaci√≥n denegados.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += 'Ubicaci√≥n no disponible.';
                                break;
                            case error.TIMEOUT:
                                errorMessage += 'Tiempo de espera agotado.';
                                break;
                            default:
                                errorMessage += error.message;
                        }
                        reject(new Error(errorMessage));
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }

        function updateLocationUI(active) {
            const control = document.getElementById('location-control');
            const warning = document.getElementById('location-warning');
            const info = document.getElementById('location-info');
            const message = document.getElementById('location-message');
            const btn = document.getElementById('btn-toggle-location');
            const btnText = document.getElementById('location-btn-text');
            const btnIcon = document.getElementById('location-btn-icon');
            const indicator = document.getElementById('location-indicator-main');
            const statusDetail = document.getElementById('location-status-detail');

            if (active) {
                control.classList.remove('inactive');
                control.classList.add('active');
                warning.classList.add('hidden');
                info.classList.remove('hidden');
                message.textContent = 'üîÑ Tu ubicaci√≥n se actualiza cada 10 segundos';
                message.classList.add('success');
                btn.classList.remove('activate');
                btn.classList.add('deactivate');
                btnText.textContent = 'Desactivar Ubicaci√≥n';
                btnIcon.textContent = 'üõë';
                indicator.classList.remove('inactive');
                indicator.classList.add('active');
                
                const timeStr = new Date().toLocaleTimeString('es-CO', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                statusDetail.textContent = `Actualizado: ${timeStr} | Total: ${locationUpdateCount} actualizaciones`;
            } else {
                control.classList.remove('active');
                control.classList.add('inactive');
                warning.classList.remove('hidden');
                info.classList.add('hidden');
                message.textContent = 'Toca el bot√≥n para compartir tu ubicaci√≥n';
                message.classList.remove('success');
                btn.classList.remove('deactivate');
                btn.classList.add('activate');
                btnText.textContent = 'Activar Ubicaci√≥n';
                btnIcon.textContent = 'üìç';
                indicator.classList.remove('active');
                indicator.classList.add('inactive');
                statusDetail.textContent = '';
            }
        }

        async function startLocationTracking() {
            try {
                console.log('üîÑ Iniciando seguimiento de ubicaci√≥n...');
                
                // Paso 1: Solicitar permiso de ubicaci√≥n
                await requestLocationPermission();
                console.log('‚úÖ Permisos de ubicaci√≥n obtenidos');
                
                // Paso 2: Obtener ubicaci√≥n inicial y verificar que funcione
                await updateLocation();
                console.log('‚úÖ Ubicaci√≥n inicial obtenida exitosamente');

                // Paso 3: Configurar actualizaciones peri√≥dicas M√ÅS FRECUENTES
                // CAMBIO: De 60 segundos a 10 segundos para actualizaciones m√°s frecuentes
                locationUpdateInterval = setInterval(async () => {
                    try {
                        await updateLocation();
                        console.log('üìç Actualizaci√≥n peri√≥dica de ubicaci√≥n (cada 10s)');
                    } catch (error) {
                        console.error('Error en actualizaci√≥n peri√≥dica:', error);
                    }
                }, 10000); // CAMBIADO: 10 segundos en lugar de 60

                // Paso 4: Configurar watchPosition para actualizaciones EN MOVIMIENTO
                // MEJORADO: Opciones m√°s agresivas para tracking continuo
                locationWatchId = navigator.geolocation.watchPosition(
                    async (position) => {
                        try {
                            const locationData = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                timestamp: new Date().toISOString(),
                                accuracy: position.coords.accuracy,
                                speed: position.coords.speed, // Velocidad si est√° disponible
                                heading: position.coords.heading // Direcci√≥n si est√° disponible
                            };

                            await supabase
                                .from('domiciliarios')
                                .update({ ubicacion: locationData })
                                .eq('id', currentDelivery.id);

                            document.getElementById('location-indicator').classList.add('active');
                            document.getElementById('location-indicator').classList.remove('inactive');
                            
                            const timeStr = new Date().toLocaleTimeString('es-CO', { 
                                hour: '2-digit', 
                                minute: '2-digit',
                                second: '2-digit' // AGREGADO: mostrar segundos
                            });
                            
                            document.getElementById('location-status').textContent = 'Ubicaci√≥n activa - Actualizado: ' + timeStr;
                            
                            // Actualizar UI del control de ubicaci√≥n
                            updateLocationUI(true);
                            
                            console.log('üìç Ubicaci√≥n actualizada (watchPosition):', {
                                lat: locationData.lat.toFixed(6),
                                lng: locationData.lng.toFixed(6),
                                accuracy: Math.round(locationData.accuracy) + 'm'
                            });
                        } catch (error) {
                            console.error('Error en watchPosition:', error);
                        }
                    },
                    (error) => {
                        console.error('Error de watchPosition:', error);
                        showAlert('‚ö†Ô∏è Error continuo de ubicaci√≥n. Verifica tus permisos.', 'warning');
                    },
                    { 
                        enableHighAccuracy: true,  // MANTENER: precisi√≥n alta
                        timeout: 10000,            // CAMBIADO: 10 segundos de timeout (antes 5)
                        maximumAge: 0              // CAMBIADO: 0 = siempre obtener ubicaci√≥n fresca (antes 30000)
                    }
                );

                console.log('‚úÖ Seguimiento de ubicaci√≥n iniciado correctamente');
                console.log('üìç Actualizaciones cada 10 segundos + watchPosition continuo');
                isLocationActive = true; // Marcar ubicaci√≥n como activa
                updateLocationUI(true); // Actualizar UI
                return true;
                
            } catch (error) {
                console.error('‚ùå Error al iniciar seguimiento de ubicaci√≥n:', error);
                
                // Limpiar cualquier configuraci√≥n parcial
                stopLocationTracking();
                
                // Mostrar mensaje espec√≠fico seg√∫n el error
                let errorMessage = '';
                if (error.code === 1 || error.message.includes('denegados') || error.message.includes('denied')) {
                    errorMessage = '‚ùå PERMISOS DENEGADOS\n\n' +
                                  'üì± Para activar permisos de ubicaci√≥n:\n\n' +
                                  '1. Haz clic en el √≠cono üîí o ‚ìò en la barra de direcciones\n' +
                                  '2. Busca "Ubicaci√≥n" o "Location"\n' +
                                  '3. Selecciona "Permitir"\n' +
                                  '4. Recarga la p√°gina\n\n' +
                                  'IMPORTANTE: Sin ubicaci√≥n activa no puedes aceptar pedidos.';
                } else if (error.code === 2 || error.message.includes('no disponible') || error.message.includes('unavailable')) {
                    errorMessage = '‚ùå GPS NO DISPONIBLE\n\n' +
                                  'üì° Verifica que:\n' +
                                  '1. El GPS est√© activado en tu dispositivo\n' +
                                  '2. Est√©s al aire libre o cerca de una ventana\n' +
                                  '3. No est√©s en modo avi√≥n\n\n' +
                                  'Intenta nuevamente cuando el GPS est√© disponible.';
                } else if (error.code === 3 || error.message.includes('Tiempo de espera') || error.message.includes('timeout')) {
                    errorMessage = '‚ùå TIEMPO DE ESPERA AGOTADO\n\n' +
                                  '‚è±Ô∏è La ubicaci√≥n tard√≥ demasiado en obtenerse.\n\n' +
                                  'Esto puede ser por:\n' +
                                  '‚Ä¢ Mala se√±al GPS\n' +
                                  '‚Ä¢ Est√°s en un lugar cerrado\n' +
                                  '‚Ä¢ Conexi√≥n lenta\n\n' +
                                  'Ve a un lugar con mejor se√±al e intenta de nuevo.';
                } else {
                    errorMessage = '‚ùå ERROR AL ACTIVAR UBICACI√ìN\n\n' + error.message + '\n\nIntenta recargar la p√°gina.';
                }
                
                alert(errorMessage);
                isLocationActive = false;
                updateLocationUI(false);
                return false;
            }
        }

        function stopLocationTracking() {
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
            if (locationUpdateInterval) {
                clearInterval(locationUpdateInterval);
                locationUpdateInterval = null;
            }
            document.getElementById('location-indicator').classList.remove('active');
            document.getElementById('location-indicator').classList.add('inactive');
            document.getElementById('location-status').textContent = 'Ubicaci√≥n desactivada';
            
            // Resetear contador
            locationUpdateCount = 0;
            
            // Actualizar estado y UI
            isLocationActive = false;
            updateLocationUI(false);
            
            console.log('üõë Seguimiento de ubicaci√≥n detenido');
        }

        window.toggleLocation = async function() {
            const btn = document.getElementById('btn-toggle-location');
            
            if (isLocationActive) {
                // Desactivar ubicaci√≥n
                if (activeOrder) {
                    showAlert('‚ö†Ô∏è No puedes desactivar la ubicaci√≥n mientras tienes un pedido activo.', 'warning');
                    return;
                }
                
                if (confirm('¬øEst√°s seguro de desactivar tu ubicaci√≥n? No podr√°s aceptar pedidos hasta que la vuelvas a activar.')) {
                    stopLocationTracking();
                    showAlert('‚úÖ Ubicaci√≥n desactivada', 'info');
                }
            } else {
                // Activar ubicaci√≥n
                btn.disabled = true;
                btn.textContent = 'Activando...';
                
                try {
                    const success = await startLocationTracking();
                    if (success) {
                        showAlert('‚úÖ ¬°Ubicaci√≥n activada! Ahora puedes aceptar pedidos.', 'success');
                    }
                } catch (error) {
                    showAlert('‚ùå Error al activar ubicaci√≥n: ' + error.message, 'danger');
                } finally {
                    btn.disabled = false;
                    const btnText = document.getElementById('location-btn-text');
                    const btnIcon = document.getElementById('location-btn-icon');
                    if (isLocationActive) {
                        btnText.textContent = 'Desactivar Ubicaci√≥n';
                        btnIcon.textContent = 'üõë';
                    } else {
                        btnText.textContent = 'Activar Ubicaci√≥n';
                        btnIcon.textContent = 'üìç';
                    }
                }
            }
        };

        async function login(phone) {
            const loginBtn = document.getElementById('login-btn');
            const phoneInput = document.getElementById('login-phone');
            
            try {
                loginBtn.disabled = true;
                loginBtn.textContent = 'Verificando...';
                
                // Validar formato de tel√©fono
                const validation = validatePhone(phone);
                if (!validation.valid) {
                    phoneInput.classList.add('error');
                    throw new Error(validation.error);
                }
                
                phoneInput.classList.remove('error');
                const cleanPhone = validation.phone;
                
                console.log('Intentando login con tel√©fono:', cleanPhone);
                
                // Buscar domiciliario
                const { data, error } = await supabase
                    .from('domiciliarios')
                    .select('*')
                    .eq('telefono', cleanPhone)
                    .maybeSingle();

                console.log('Resultado de b√∫squeda:', { data, error });

                if (error) {
                    console.error('Error de Supabase:', error);
                    throw new Error('Error al conectar con el servidor: ' + error.message);
                }

                if (!data) {
                    phoneInput.classList.add('error');
                    throw new Error(`‚ùå N√∫mero ${cleanPhone} no registrado en el sistema.\n\nVerifica que:\n‚Ä¢ El n√∫mero est√© registrado\n‚Ä¢ Incluya +57 seguido de 10 d√≠gitos\n‚Ä¢ No tenga espacios ni guiones`);
                }

                currentDelivery = data;
                localStorage.setItem('fluxi_delivery', JSON.stringify(data));
                
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('delivery-name').textContent = data.nombre;

                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }

                setupRealtimeSubscription();

                await loadOrders();
                setInterval(loadOrders, 30000);
                
                showAlert(`‚úÖ ¬°Bienvenido ${data.nombre}!`, 'success');
                
            } catch (error) {
                console.error('Error en login:', error);
                showAlert(error.message, 'danger');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Iniciar Sesi√≥n';
            }
        }

        async function loadOrders() {
            if (!currentDelivery) return;

            try {
                const { data: activeOrders } = await supabase
                    .from('pedidos')
                    .select('*')
                    .eq('domiciliario_id', currentDelivery.id)
                    .in('estado', ['asignado', 'en_camino'])
                    .order('created_at', { ascending: false });

                if (activeOrders && activeOrders.length > 0) {
                    activeOrder = activeOrders[0];
                    renderActiveOrder(activeOrder);
                    
                    // Si hay pedido activo y la ubicaci√≥n no est√° activa, activarla autom√°ticamente
                    if (!isLocationActive) {
                        console.log('üîÑ Pedido activo detectado, activando ubicaci√≥n autom√°ticamente...');
                        await startLocationTracking();
                    }
                } else {
                    activeOrder = null;
                    document.getElementById('active-order-container').classList.add('hidden');
                    stopTimer();
                    
                    await supabase
                        .from('domiciliarios')
                        .update({ estado: 'disponible' })
                        .eq('id', currentDelivery.id);
                }

                const { data: availableOrders } = await supabase
                    .from('pedidos')
                    .select('*')
                    .eq('estado', 'pendiente')
                    .is('domiciliario_id', null)
                    .order('created_at', { ascending: false });

                renderAvailableOrders(availableOrders || []);

                await updateStats();
            } catch (error) {
                console.error('Error cargando pedidos:', error);
            }
        }

        function renderActiveOrder(order) {
            document.getElementById('active-order-container').classList.remove('hidden');
            document.getElementById('available-orders-container').classList.add('hidden');

            // Iniciar temporizador si el pedido est√° en camino
            if (order.estado === 'en_camino' && !timerInterval) {
                // Recuperar tiempo de inicio desde la BD
                const startTime = order.tiempo_aceptacion || Date.now();
                console.log('‚è±Ô∏è Recuperando temporizador desde:', new Date(startTime).toLocaleTimeString());
                startTimer(startTime);
            }

            const card = `
                <div class="order-card active">
                    <div class="order-header">
                        <div class="order-id">#${order.id.substring(0, 8)}</div>
                        <span class="order-status ${order.estado}">${order.estado === 'asignado' ? 'Asignado' : 'En Camino'}</span>
                    </div>
                    <div class="order-detail">
                        <div class="order-detail-row">
                            <div class="order-detail-label">üë§ Cliente:</div>
                            <div class="order-detail-value">${order.cliente}</div>
                        </div>
                        <div class="order-detail-row">
                            <div class="order-detail-label">üìû Tel√©fono:</div>
                            <div class="order-detail-value">${order.telefono_cliente}</div>
                        </div>
                        <div class="order-detail-row">
                            <div class="order-detail-label">üìç Direcci√≥n:</div>
                            <div class="order-detail-value">${order.direccion}</div>
                        </div>
                        <div class="order-detail-row">
                            <div class="order-detail-label">üí∞ Total:</div>
                            <div class="order-detail-value">${formatCurrency(order.valor_pedido + order.valor_domicilio)}</div>
                        </div>
                        <div class="order-detail-row">
                            <div class="order-detail-label">üí≥ Pago:</div>
                            <div class="order-detail-value">${order.metodo_pago === 'efectivo' ? 'Efectivo' : 'Tarjeta'}</div>
                        </div>
                        ${order.notas ? `
                        <div class="order-detail-row">
                            <div class="order-detail-label">üìù Notas:</div>
                            <div class="order-detail-value">${order.notas}</div>
                        </div>
                        ` : ''}
                    </div>
                    <div class="action-buttons ${order.estado === 'asignado' ? '' : 'single'}">
                        ${order.estado === 'asignado' ? `
                            <button class="btn btn-success" onclick="window.startDelivery('${order.id}')">
                                üöÄ Iniciar Entrega
                            </button>
                        ` : ''}
                        ${order.estado === 'en_camino' ? `
                            <button class="btn btn-primary" onclick="window.completeDelivery('${order.id}')">
                                ‚úÖ Marcar Entregado
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;

            document.getElementById('active-order-card').innerHTML = card;
        }

        function renderAvailableOrders(orders) {
            const container = document.getElementById('orders-list');
            
            if (!activeOrder) {
                document.getElementById('available-orders-container').classList.remove('hidden');
            }

            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <div class="empty-state-text">No hay pedidos disponibles</div>
                        <div class="empty-state-subtext">Los nuevos pedidos aparecer√°n aqu√≠ autom√°ticamente</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = orders.map(order => `
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-id">#${order.id.substring(0, 8)}</div>
                        <span class="order-status pendiente">Disponible</span>
                    </div>
                    <div class="order-detail">
                        <div class="order-detail-row">
                            <div class="order-detail-label">üë§ Cliente:</div>
                            <div class="order-detail-value">${order.cliente}</div>
                        </div>
                        <div class="order-detail-row">
                            <div class="order-detail-label">üìç Direcci√≥n:</div>
                            <div class="order-detail-value">${order.direccion}</div>
                        </div>
                        <div class="order-detail-row">
                            <div class="order-detail-label">üí∞ Total:</div>
                            <div class="order-detail-value">${formatCurrency(order.valor_pedido + order.valor_domicilio)}</div>
                        </div>
                        <div class="order-detail-row">
                            <div class="order-detail-label">üí≥ Pago:</div>
                            <div class="order-detail-value">${order.metodo_pago === 'efectivo' ? 'Efectivo' : 'Tarjeta'}</div>
                        </div>
                    </div>
                    ${!isLocationActive ? `
                        <div style="padding: 10px; background: rgba(231, 76, 60, 0.1); border-radius: 8px; margin-bottom: 10px; font-size: 13px; color: #e74c3c;">
                            ‚ö†Ô∏è Activa tu ubicaci√≥n arriba para aceptar pedidos
                        </div>
                    ` : ''}
                    <button class="btn btn-primary" onclick="window.acceptOrder('${order.id}')" ${!isLocationActive ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                        ‚úÖ Aceptar Pedido
                    </button>
                </div>
            `).join('');
        }

        async function updateStats() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const { data: allOrders } = await supabase
                .from('pedidos')
                .select('*')
                .eq('domiciliario_id', currentDelivery.id);

            const todayOrders = (allOrders || []).filter(o => 
                new Date(o.created_at) >= today
            );

            const completed = (allOrders || []).filter(o => o.estado === 'entregado').length;
            const active = (allOrders || []).filter(o => 
                o.estado === 'asignado' || o.estado === 'en_camino'
            ).length;

            document.getElementById('orders-today').textContent = todayOrders.length;
            document.getElementById('orders-completed').textContent = completed;
            document.getElementById('orders-active').textContent = active;
        }

        window.acceptOrder = async function(orderId) {
            if (activeOrder) {
                showAlert('Ya tienes un pedido activo. Compl√©talo antes de aceptar otro.', 'warning');
                return;
            }

            // CR√çTICO: Verificar que la ubicaci√≥n est√© activa
            if (!isLocationActive) {
                showAlert('‚ùå Debes activar tu ubicaci√≥n antes de aceptar pedidos. Toca el bot√≥n "Activar Ubicaci√≥n" arriba.', 'danger');
                // Hacer scroll al control de ubicaci√≥n
                document.getElementById('location-control').scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }

            // Deshabilitar bot√≥n temporalmente para evitar m√∫ltiples clicks
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = true);

            try {
                console.log('üîç Iniciando proceso de aceptaci√≥n de pedido:', orderId);
                
                // Verificar que efectivamente tenemos una ubicaci√≥n guardada y reciente
                const { data: deliveryData } = await supabase
                    .from('domiciliarios')
                    .select('ubicacion')
                    .eq('id', currentDelivery.id)
                    .single();

                console.log('üîç deliveryData:', deliveryData);

                if (!deliveryData || !deliveryData.ubicacion || !deliveryData.ubicacion.lat) {
                    throw new Error('No se pudo verificar tu ubicaci√≥n. Intenta nuevamente.');
                }

                // Verificar que la ubicaci√≥n sea reciente (menos de 2 minutos)
                const locationTimestamp = new Date(deliveryData.ubicacion.timestamp);
                const now = new Date();
                const diffMinutes = (now - locationTimestamp) / 1000 / 60;
                
                if (diffMinutes > 2) {
                    throw new Error('Tu ubicaci√≥n no est√° actualizada. Por favor, espera un momento e intenta de nuevo.');
                }

                console.log('‚úÖ Ubicaci√≥n verificada y actual:', deliveryData.ubicacion);

                // Aceptar el pedido
                const updateData = {
                    estado: 'asignado',
                    domiciliario_id: currentDelivery.id,
                    domiciliario_nombre: currentDelivery.nombre,
                    domiciliario_telefono: currentDelivery.telefono,
                    tiempo_aceptacion: Date.now(),
                    updated_at: new Date().toISOString()
                };
                
                console.log('üìù Actualizando pedido con datos:', updateData);
                
                const { data: updatedOrder, error } = await supabase
                    .from('pedidos')
                    .update(updateData)
                    .eq('id', orderId)
                    .select()
                    .single();

                if (error) {
                    console.error('‚ùå Error al actualizar pedido:', error);
                    throw error;
                }
                
                console.log('‚úÖ Pedido actualizado exitosamente:', updatedOrder);

                // Actualizar estado del domiciliario
                const { error: deliveryError } = await supabase
                    .from('domiciliarios')
                    .update({ estado: 'ocupado' })
                    .eq('id', currentDelivery.id);
                    
                if (deliveryError) {
                    console.error('‚ö†Ô∏è Error al actualizar estado del domiciliario:', deliveryError);
                }

                showAlert('‚úÖ ¬°Pedido aceptado! Tu ubicaci√≥n est√° siendo rastreada. Recuerda iniciar la entrega cuando salgas.', 'success');
                
                console.log('üîÑ Recargando pedidos...');
                await loadOrders();
                console.log('‚úÖ Pedidos recargados');
                
            } catch (error) {
                console.error('‚ùå Error al aceptar el pedido:', error);
                showAlert('‚ùå Error: ' + error.message, 'danger');
                
                // Si fall√≥, verificar que la ubicaci√≥n siga activa
                if (!isLocationActive) {
                    stopLocationTracking();
                }
            } finally {
                // Rehabilitar botones
                buttons.forEach(btn => btn.disabled = false);
            }
        };

        window.startDelivery = async function(orderId) {
            console.log('üöÄ ========== INICIANDO ENTREGA ==========');
            console.log('   - Pedido ID:', orderId);
            
            // Deshabilitar botones temporalmente
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = true);
            
            try {
                const startTime = Date.now();
                console.log('   - Tiempo de inicio:', new Date(startTime).toLocaleTimeString());
                
                const updateData = {
                    estado: 'en_camino',
                    updated_at: new Date().toISOString()
                };
                
                console.log('   - Datos a actualizar:', updateData);
                
                const { data: updatedOrder, error } = await supabase
                    .from('pedidos')
                    .update(updateData)
                    .eq('id', orderId)
                    .select()
                    .single();

                if (error) {
                    console.error('‚ùå Error de Supabase:', error);
                    throw error;
                }
                
                console.log('‚úÖ Pedido actualizado:', updatedOrder);

                startTimer(startTime);
                showAlert('‚úÖ ¬°Entrega iniciada! El temporizador est√° corriendo.', 'success');
                
                console.log('üîÑ Recargando pedidos...');
                await loadOrders();
                console.log('‚úÖ ========== ENTREGA INICIADA EXITOSAMENTE ==========');
                
            } catch (error) {
                console.error('‚ùå ========== ERROR AL INICIAR ENTREGA ==========');
                console.error('Error completo:', error);
                showAlert('‚ùå Error al iniciar entrega: ' + error.message, 'danger');
            } finally {
                // Rehabilitar botones
                buttons.forEach(btn => btn.disabled = false);
            }
        };

        window.completeDelivery = async function(orderId) {
            console.log('‚úÖ ========== COMPLETANDO ENTREGA ==========');
            console.log('   - Pedido ID:', orderId);
            
            // VALIDACI√ìN: Verificar que el pedido est√© en estado "en_camino"
            if (activeOrder && activeOrder.estado !== 'en_camino') {
                console.warn('‚ö†Ô∏è Intento de completar pedido sin iniciar');
                showAlert('‚ö†Ô∏è Debes iniciar la entrega antes de marcarla como entregada. Presiona "üöÄ Iniciar Entrega" primero.', 'warning');
                return;
            }
            
            if (!confirm('¬øConfirmas que el pedido fue entregado?')) return;

            // Deshabilitar botones temporalmente
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = true);

            try {
                const deliveryTime = Date.now();
                console.log('   - Tiempo de entrega:', new Date(deliveryTime).toLocaleTimeString());
                
                const { data: updatedOrder, error } = await supabase
                    .from('pedidos')
                    .update({
                        estado: 'entregado',
                        tiempo_entrega: deliveryTime,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', orderId)
                    .select()
                    .single();

                if (error) {
                    console.error('‚ùå Error de Supabase:', error);
                    throw error;
                }
                
                console.log('‚úÖ Pedido marcado como entregado:', updatedOrder);

                // Actualizar estado del domiciliario a disponible
                const { error: deliveryError } = await supabase
                    .from('domiciliarios')
                    .update({ 
                        estado: 'disponible'
                    })
                    .eq('id', currentDelivery.id);
                    
                if (deliveryError) {
                    console.error('‚ö†Ô∏è Error al actualizar estado del domiciliario:', deliveryError);
                }

                stopTimer();
                stopLocationTracking();
                
                showAlert('‚úÖ ¬°Pedido completado exitosamente! üéâ', 'success');
                
                console.log('üîÑ Recargando pedidos...');
                await loadOrders();
                console.log('‚úÖ ========== ENTREGA COMPLETADA EXITOSAMENTE ==========');
                
            } catch (error) {
                console.error('‚ùå ========== ERROR AL COMPLETAR ENTREGA ==========');
                console.error('Error completo:', error);
                showAlert('‚ùå Error al completar pedido: ' + error.message, 'danger');
            } finally {
                // Rehabilitar botones
                buttons.forEach(btn => btn.disabled = false);
            }
        };

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const phone = document.getElementById('login-phone').value;
            await login(phone);
        });

        document.getElementById('login-phone').addEventListener('input', function() {
            this.classList.remove('error');
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            if (confirm('¬øSeguro que deseas cerrar sesi√≥n?')) {
                localStorage.removeItem('fluxi_delivery');
                stopLocationTracking();
                stopTimer();
                if (realtimeChannel) {
                    supabase.removeChannel(realtimeChannel);
                }
                location.reload();
            }
        });

        window.addEventListener('load', async () => {
            const saved = localStorage.getItem('fluxi_delivery');
            if (saved) {
                currentDelivery = JSON.parse(saved);
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('delivery-name').textContent = currentDelivery.nombre;
                
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
                
                setupRealtimeSubscription();
                
                await loadOrders();
                setInterval(loadOrders, 30000);
            }
        });
    </script>
</body>
</html>
